{"version":3,"file":"index.min.js","sources":["../../src/util.ts","../../src/feature-repository.ts","../../../../node_modules/.pnpm/dom-mutator@0.6.0/node_modules/dom-mutator/dist/dom-mutator.esm.js","../../src/mongrule.ts","../../src/core.ts","../../src/GrowthBook.ts","../../src/GrowthBookClient.ts","../../src/sticky-bucket-service.ts"],"sourcesContent":["import {\n  AutoExperiment,\n  AutoExperimentChangeType,\n  Polyfills,\n  UrlTarget,\n  UrlTargetType,\n  VariationRange,\n} from \"./types/growthbook\";\n\nconst polyfills: Polyfills = {\n  fetch: globalThis.fetch ? globalThis.fetch.bind(globalThis) : undefined,\n  SubtleCrypto: globalThis.crypto ? globalThis.crypto.subtle : undefined,\n  EventSource: globalThis.EventSource,\n};\nexport function getPolyfills(): Polyfills {\n  return polyfills;\n}\n\nfunction hashFnv32a(str: string): number {\n  let hval = 0x811c9dc5;\n  const l = str.length;\n\n  for (let i = 0; i < l; i++) {\n    hval ^= str.charCodeAt(i);\n    hval +=\n      (hval << 1) + (hval << 4) + (hval << 7) + (hval << 8) + (hval << 24);\n  }\n  return hval >>> 0;\n}\n\nexport function hash(\n  seed: string,\n  value: string,\n  version: number,\n): number | null {\n  // New unbiased hashing algorithm\n  if (version === 2) {\n    return (hashFnv32a(hashFnv32a(seed + value) + \"\") % 10000) / 10000;\n  }\n  // Original biased hashing algorithm (keep for backwards compatibility)\n  if (version === 1) {\n    return (hashFnv32a(value + seed) % 1000) / 1000;\n  }\n\n  // Unknown hash version\n  return null;\n}\n\nexport function getEqualWeights(n: number): number[] {\n  if (n <= 0) return [];\n  return new Array(n).fill(1 / n);\n}\n\nexport function inRange(n: number, range: VariationRange): boolean {\n  return n >= range[0] && n < range[1];\n}\n\nexport function inNamespace(\n  hashValue: string,\n  namespace: [string, number, number],\n): boolean {\n  const n = hash(\"__\" + namespace[0], hashValue, 1);\n  if (n === null) return false;\n  return n >= namespace[1] && n < namespace[2];\n}\n\nexport function chooseVariation(n: number, ranges: VariationRange[]): number {\n  for (let i = 0; i < ranges.length; i++) {\n    if (inRange(n, ranges[i])) {\n      return i;\n    }\n  }\n  return -1;\n}\n\nexport function getUrlRegExp(regexString: string): RegExp | undefined {\n  try {\n    const escaped = regexString.replace(/([^\\\\])\\//g, \"$1\\\\/\");\n    return new RegExp(escaped);\n  } catch (e) {\n    console.error(e);\n    return undefined;\n  }\n}\n\nexport function isURLTargeted(url: string, targets: UrlTarget[]) {\n  if (!targets.length) return false;\n  let hasIncludeRules = false;\n  let isIncluded = false;\n\n  for (let i = 0; i < targets.length; i++) {\n    const match = _evalURLTarget(url, targets[i].type, targets[i].pattern);\n    if (targets[i].include === false) {\n      if (match) return false;\n    } else {\n      hasIncludeRules = true;\n      if (match) isIncluded = true;\n    }\n  }\n\n  return isIncluded || !hasIncludeRules;\n}\n\nfunction _evalSimpleUrlPart(\n  actual: string,\n  pattern: string,\n  isPath: boolean,\n): boolean {\n  try {\n    // Escape special regex characters and change wildcard `_____` to `.*`\n    let escaped = pattern\n      .replace(/[*.+?^${}()|[\\]\\\\]/g, \"\\\\$&\")\n      .replace(/_____/g, \".*\");\n\n    if (isPath) {\n      // When matching pathname, make leading/trailing slashes optional\n      escaped = \"\\\\/?\" + escaped.replace(/(^\\/|\\/$)/g, \"\") + \"\\\\/?\";\n    }\n\n    const regex = new RegExp(\"^\" + escaped + \"$\", \"i\");\n    return regex.test(actual);\n  } catch (e) {\n    return false;\n  }\n}\n\nfunction _evalSimpleUrlTarget(actual: URL, pattern: string) {\n  try {\n    // If a protocol is missing, but a host is specified, add `https://` to the front\n    // Use \"_____\" as the wildcard since `*` is not a valid hostname in some browsers\n    const expected = new URL(\n      pattern.replace(/^([^:/?]*)\\./i, \"https://$1.\").replace(/\\*/g, \"_____\"),\n      \"https://_____\",\n    );\n\n    // Compare each part of the URL separately\n    const comps: Array<[string, string, boolean]> = [\n      [actual.host, expected.host, false],\n      [actual.pathname, expected.pathname, true],\n    ];\n    // We only want to compare hashes if it's explicitly being targeted\n    if (expected.hash) {\n      comps.push([actual.hash, expected.hash, false]);\n    }\n\n    expected.searchParams.forEach((v, k) => {\n      comps.push([actual.searchParams.get(k) || \"\", v, false]);\n    });\n\n    // If any comparisons fail, the whole thing fails\n    return !comps.some(\n      (data) => !_evalSimpleUrlPart(data[0], data[1], data[2]),\n    );\n  } catch (e) {\n    return false;\n  }\n}\n\nfunction _evalURLTarget(\n  url: string,\n  type: UrlTargetType,\n  pattern: string,\n): boolean {\n  try {\n    const parsed = new URL(url, \"https://_\");\n\n    if (type === \"regex\") {\n      const regex = getUrlRegExp(pattern);\n      if (!regex) return false;\n      return (\n        regex.test(parsed.href) ||\n        regex.test(parsed.href.substring(parsed.origin.length))\n      );\n    } else if (type === \"simple\") {\n      return _evalSimpleUrlTarget(parsed, pattern);\n    }\n\n    return false;\n  } catch (e) {\n    return false;\n  }\n}\n\nexport function getBucketRanges(\n  numVariations: number,\n  coverage: number | undefined,\n  weights?: number[],\n): VariationRange[] {\n  coverage = coverage === undefined ? 1 : coverage;\n\n  // Make sure coverage is within bounds\n  if (coverage < 0) {\n    if (process.env.NODE_ENV !== \"production\") {\n      console.error(\"Experiment.coverage must be greater than or equal to 0\");\n    }\n    coverage = 0;\n  } else if (coverage > 1) {\n    if (process.env.NODE_ENV !== \"production\") {\n      console.error(\"Experiment.coverage must be less than or equal to 1\");\n    }\n    coverage = 1;\n  }\n\n  // Default to equal weights if missing or invalid\n  const equal = getEqualWeights(numVariations);\n  weights = weights || equal;\n  if (weights.length !== numVariations) {\n    if (process.env.NODE_ENV !== \"production\") {\n      console.error(\n        \"Experiment.weights array must be the same length as Experiment.variations\",\n      );\n    }\n    weights = equal;\n  }\n\n  // If weights don't add up to 1 (or close to it), default to equal weights\n  const totalWeight = weights.reduce((w, sum) => sum + w, 0);\n  if (totalWeight < 0.99 || totalWeight > 1.01) {\n    if (process.env.NODE_ENV !== \"production\") {\n      console.error(\"Experiment.weights must add up to 1\");\n    }\n    weights = equal;\n  }\n\n  // Covert weights to ranges\n  let cumulative = 0;\n  return weights.map((w) => {\n    const start = cumulative;\n    cumulative += w;\n    return [start, start + (coverage as number) * w];\n  }) as VariationRange[];\n}\n\nexport function getQueryStringOverride(\n  id: string,\n  url: string,\n  numVariations: number,\n) {\n  if (!url) {\n    return null;\n  }\n\n  const search = url.split(\"?\")[1];\n  if (!search) {\n    return null;\n  }\n\n  const match = search\n    .replace(/#.*/, \"\") // Get rid of anchor\n    .split(\"&\") // Split into key/value pairs\n    .map((kv) => kv.split(\"=\", 2))\n    .filter(([k]) => k === id) // Look for key that matches the experiment id\n    .map(([, v]) => parseInt(v)); // Parse the value into an integer\n\n  if (match.length > 0 && match[0] >= 0 && match[0] < numVariations)\n    return match[0];\n\n  return null;\n}\n\nexport function isIncluded(include: () => boolean) {\n  try {\n    return include();\n  } catch (e) {\n    console.error(e);\n    return false;\n  }\n}\n\nconst base64ToBuf = (b: string) =>\n  Uint8Array.from(atob(b), (c) => c.charCodeAt(0));\n\nexport async function decrypt(\n  encryptedString: string,\n  decryptionKey?: string,\n  subtle?: SubtleCrypto,\n): Promise<string> {\n  decryptionKey = decryptionKey || \"\";\n  subtle =\n    subtle ||\n    (globalThis.crypto && globalThis.crypto.subtle) ||\n    polyfills.SubtleCrypto;\n  if (!subtle) {\n    throw new Error(\"No SubtleCrypto implementation found\");\n  }\n  try {\n    const key = await subtle.importKey(\n      \"raw\",\n      base64ToBuf(decryptionKey),\n      { name: \"AES-CBC\", length: 128 },\n      true,\n      [\"encrypt\", \"decrypt\"],\n    );\n    const [iv, cipherText] = encryptedString.split(\".\");\n    const plainTextBuffer = await subtle.decrypt(\n      { name: \"AES-CBC\", iv: base64ToBuf(iv) },\n      key,\n      base64ToBuf(cipherText),\n    );\n\n    return new TextDecoder().decode(plainTextBuffer);\n  } catch (e) {\n    throw new Error(\"Failed to decrypt\");\n  }\n}\n\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nexport function toString(input: any): string {\n  if (typeof input === \"string\") return input;\n  return JSON.stringify(input);\n}\n\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nexport function paddedVersionString(input: any): string {\n  if (typeof input === \"number\") {\n    input = input + \"\";\n  }\n  if (!input || typeof input !== \"string\") {\n    input = \"0\";\n  }\n  // Remove build info and leading `v` if any\n  // Split version into parts (both core version numbers and pre-release tags)\n  // \"v1.2.3-rc.1+build123\" -> [\"1\",\"2\",\"3\",\"rc\",\"1\"]\n  const parts = (input as string).replace(/(^v|\\+.*$)/g, \"\").split(/[-.]/);\n\n  // If it's SemVer without a pre-release, add `~` to the end\n  // [\"1\",\"0\",\"0\"] -> [\"1\",\"0\",\"0\",\"~\"]\n  // \"~\" is the largest ASCII character, so this will make \"1.0.0\" greater than \"1.0.0-beta\" for example\n  if (parts.length === 3) {\n    parts.push(\"~\");\n  }\n\n  // Left pad each numeric part with spaces so string comparisons will work (\"9\">\"10\", but \" 9\"<\"10\")\n  // Then, join back together into a single string\n  return parts\n    .map((v) => (v.match(/^[0-9]+$/) ? v.padStart(5, \" \") : v))\n    .join(\"-\");\n}\n\nexport function loadSDKVersion(): string {\n  let version: string;\n  try {\n    // @ts-expect-error right-hand value to be replaced by build with string literal\n    version = __SDK_VERSION__;\n  } catch (e) {\n    version = \"\";\n  }\n  return version;\n}\n\nexport function mergeQueryStrings(oldUrl: string, newUrl: string): string {\n  let currUrl: URL;\n  let redirectUrl: URL;\n  try {\n    currUrl = new URL(oldUrl);\n    redirectUrl = new URL(newUrl);\n  } catch (e) {\n    console.error(`Unable to merge query strings: ${e}`);\n    return newUrl;\n  }\n\n  currUrl.searchParams.forEach((value, key) => {\n    // skip  if search param already exists in redirectUrl\n    if (redirectUrl.searchParams.has(key)) {\n      return;\n    }\n    redirectUrl.searchParams.set(key, value);\n  });\n\n  return redirectUrl.toString();\n}\n\nfunction isObj(x: unknown): x is Record<string, unknown> {\n  return typeof x === \"object\" && x !== null;\n}\n\nexport function getAutoExperimentChangeType(\n  exp: AutoExperiment,\n): AutoExperimentChangeType {\n  if (\n    exp.urlPatterns &&\n    exp.variations.some(\n      (variation) => isObj(variation) && \"urlRedirect\" in variation,\n    )\n  ) {\n    return \"redirect\";\n  } else if (\n    exp.variations.some(\n      (variation) =>\n        isObj(variation) &&\n        (variation.domMutations || \"js\" in variation || \"css\" in variation),\n    )\n  ) {\n    return \"visual\";\n  }\n\n  return \"unknown\";\n}\n\n// Guarantee the promise always resolves within {timeout} ms\n// Resolved value will be `null` when there's an error or it takes too long\n// Note: The promise will continue running in the background, even if the timeout is hit\nexport async function promiseTimeout<T>(\n  promise: Promise<T>,\n  timeout?: number,\n): Promise<T | null> {\n  return new Promise((resolve) => {\n    let resolved = false;\n    let timer: NodeJS.Timeout | undefined;\n    const finish = (data?: T) => {\n      if (resolved) return;\n      resolved = true;\n      timer && clearTimeout(timer);\n      resolve(data || null);\n    };\n\n    if (timeout) {\n      timer = setTimeout(() => finish(), timeout);\n    }\n\n    promise.then((data) => finish(data)).catch(() => finish());\n  });\n}\n","import {\n  Attributes,\n  CacheSettings,\n  FeatureApiResponse,\n  FetchResponse,\n  Helpers,\n  Polyfills,\n} from \"./types/growthbook\";\nimport { getPolyfills, promiseTimeout } from \"./util\";\nimport type {\n  GrowthBook,\n  InitOptions,\n  InitSyncOptions,\n  GrowthBookClient,\n} from \".\";\n\ntype CacheEntry = {\n  data: FeatureApiResponse;\n  sse?: boolean;\n  version: string;\n  staleAt: Date;\n};\ntype ScopedChannel = {\n  src: EventSource | null;\n  cb: (event: MessageEvent<string>) => void;\n  host: string;\n  clientKey: string;\n  headers?: Record<string, string>;\n  errors: number;\n  state: \"active\" | \"idle\" | \"disabled\";\n};\n\n// Config settings\nconst cacheSettings: CacheSettings = {\n  // Consider a fetch stale after 1 minute\n  staleTTL: 1000 * 60,\n  // Max time to keep a fetch in cache (4 hours default)\n  maxAge: 1000 * 60 * 60 * 4,\n  cacheKey: \"gbFeaturesCache\",\n  backgroundSync: true,\n  maxEntries: 10,\n  disableIdleStreams: false,\n  idleStreamInterval: 20000,\n  disableCache: false,\n};\n\nconst polyfills = getPolyfills();\n\nexport const helpers: Helpers = {\n  fetchFeaturesCall: ({ host, clientKey, headers }) => {\n    return (polyfills.fetch as typeof globalThis.fetch)(\n      `${host}/api/features/${clientKey}`,\n      { headers },\n    );\n  },\n  fetchRemoteEvalCall: ({ host, clientKey, payload, headers }) => {\n    const options = {\n      method: \"POST\",\n      headers: { \"Content-Type\": \"application/json\", ...headers },\n      body: JSON.stringify(payload),\n    };\n    return (polyfills.fetch as typeof globalThis.fetch)(\n      `${host}/api/eval/${clientKey}`,\n      options,\n    );\n  },\n  eventSourceCall: ({ host, clientKey, headers }) => {\n    if (headers) {\n      return new polyfills.EventSource(`${host}/sub/${clientKey}`, {\n        headers,\n      });\n    }\n    return new polyfills.EventSource(`${host}/sub/${clientKey}`);\n  },\n  startIdleListener: () => {\n    let idleTimeout: number | undefined;\n    const isBrowser =\n      typeof window !== \"undefined\" && typeof document !== \"undefined\";\n    if (!isBrowser) return;\n    const onVisibilityChange = () => {\n      if (document.visibilityState === \"visible\") {\n        window.clearTimeout(idleTimeout);\n        onVisible();\n      } else if (document.visibilityState === \"hidden\") {\n        idleTimeout = window.setTimeout(\n          onHidden,\n          cacheSettings.idleStreamInterval,\n        );\n      }\n    };\n    document.addEventListener(\"visibilitychange\", onVisibilityChange);\n    return () =>\n      document.removeEventListener(\"visibilitychange\", onVisibilityChange);\n  },\n  stopIdleListener: () => {\n    // No-op, replaced by startIdleListener\n  },\n};\n\ntry {\n  if (globalThis.localStorage) {\n    polyfills.localStorage = globalThis.localStorage;\n  }\n} catch (e) {\n  // Ignore localStorage errors\n}\n\n// Global state\nconst subscribedInstances: Map<\n  string,\n  Set<GrowthBook | GrowthBookClient>\n> = new Map();\nlet cacheInitialized = false;\nconst cache: Map<string, CacheEntry> = new Map();\nconst activeFetches: Map<string, Promise<FetchResponse>> = new Map();\nconst streams: Map<string, ScopedChannel> = new Map();\nconst supportsSSE: Set<string> = new Set();\n\n// Public functions\nexport function setPolyfills(overrides: Partial<Polyfills>): void {\n  Object.assign(polyfills, overrides);\n}\nexport function configureCache(overrides: Partial<CacheSettings>): void {\n  Object.assign(cacheSettings, overrides);\n  if (!cacheSettings.backgroundSync) {\n    clearAutoRefresh();\n  }\n}\n\nexport async function clearCache(): Promise<void> {\n  cache.clear();\n  activeFetches.clear();\n  clearAutoRefresh();\n  cacheInitialized = false;\n  await updatePersistentCache();\n}\n\n// Get or fetch features and refresh the SDK instance\nexport async function refreshFeatures({\n  instance,\n  timeout,\n  skipCache,\n  allowStale,\n  backgroundSync,\n}: {\n  instance: GrowthBook | GrowthBookClient;\n  timeout?: number;\n  skipCache?: boolean;\n  allowStale?: boolean;\n  backgroundSync?: boolean;\n}): Promise<FetchResponse> {\n  if (!backgroundSync) {\n    cacheSettings.backgroundSync = false;\n  }\n\n  return fetchFeaturesWithCache({\n    instance,\n    allowStale,\n    timeout,\n    skipCache,\n  });\n}\n\n// Subscribe a GrowthBook instance to feature changes\nfunction subscribe(instance: GrowthBook | GrowthBookClient): void {\n  const key = getKey(instance);\n  const subs = subscribedInstances.get(key) || new Set();\n  subs.add(instance);\n  subscribedInstances.set(key, subs);\n}\nexport function unsubscribe(instance: GrowthBook | GrowthBookClient): void {\n  subscribedInstances.forEach((s) => s.delete(instance));\n}\n\nexport function onHidden() {\n  streams.forEach((channel) => {\n    if (!channel) return;\n    channel.state = \"idle\";\n    disableChannel(channel);\n  });\n}\n\nexport function onVisible() {\n  streams.forEach((channel) => {\n    if (!channel) return;\n    if (channel.state !== \"idle\") return;\n    enableChannel(channel);\n  });\n}\n\n// Private functions\n\nasync function updatePersistentCache() {\n  try {\n    if (!polyfills.localStorage) return;\n    await polyfills.localStorage.setItem(\n      cacheSettings.cacheKey,\n      JSON.stringify(Array.from(cache.entries())),\n    );\n  } catch (e) {\n    // Ignore localStorage errors\n  }\n}\n\n// SWR wrapper for fetching features. May indirectly or directly start SSE streaming.\nasync function fetchFeaturesWithCache({\n  instance,\n  allowStale,\n  timeout,\n  skipCache,\n}: {\n  instance: GrowthBook | GrowthBookClient;\n  allowStale?: boolean;\n  timeout?: number;\n  skipCache?: boolean;\n}): Promise<FetchResponse> {\n  const key = getKey(instance);\n  const cacheKey = getCacheKey(instance);\n  const now = new Date();\n\n  const minStaleAt = new Date(\n    now.getTime() - cacheSettings.maxAge + cacheSettings.staleTTL,\n  );\n\n  await initializeCache();\n  const existing =\n    !cacheSettings.disableCache && !skipCache ? cache.get(cacheKey) : undefined;\n  if (\n    existing &&\n    (allowStale || existing.staleAt > now) &&\n    existing.staleAt > minStaleAt\n  ) {\n    // Restore from cache whether SSE is supported\n    if (existing.sse) supportsSSE.add(key);\n\n    // Reload features in the background if stale\n    if (existing.staleAt < now) {\n      fetchFeatures(instance);\n    }\n    // Otherwise, if we don't need to refresh now, start a background sync\n    else {\n      startAutoRefresh(instance);\n    }\n    return { data: existing.data, success: true, source: \"cache\" };\n  } else {\n    const res = await promiseTimeout(fetchFeatures(instance), timeout);\n    return (\n      res || {\n        data: null,\n        success: false,\n        source: \"timeout\",\n        error: new Error(\"Timeout\"),\n      }\n    );\n  }\n}\n\nfunction getKey(instance: GrowthBook | GrowthBookClient): string {\n  const [apiHost, clientKey] = instance.getApiInfo();\n  return `${apiHost}||${clientKey}`;\n}\n\nfunction getCacheKey(instance: GrowthBook | GrowthBookClient): string {\n  const baseKey = getKey(instance);\n  if (!(\"isRemoteEval\" in instance) || !instance.isRemoteEval()) return baseKey;\n\n  const attributes = instance.getAttributes();\n  const cacheKeyAttributes =\n    instance.getCacheKeyAttributes() || Object.keys(instance.getAttributes());\n  const ca: Attributes = {};\n  cacheKeyAttributes.forEach((key) => {\n    ca[key] = attributes[key];\n  });\n\n  const fv = instance.getForcedVariations();\n  const url = instance.getUrl();\n\n  return `${baseKey}||${JSON.stringify({\n    ca,\n    fv,\n    url,\n  })}`;\n}\n\n// Populate cache from localStorage (if available)\nasync function initializeCache(): Promise<void> {\n  if (cacheInitialized) return;\n  cacheInitialized = true;\n  try {\n    if (polyfills.localStorage) {\n      const value = await polyfills.localStorage.getItem(\n        cacheSettings.cacheKey,\n      );\n      if (!cacheSettings.disableCache && value) {\n        const parsed: [string, CacheEntry][] = JSON.parse(value);\n        if (parsed && Array.isArray(parsed)) {\n          parsed.forEach(([key, data]) => {\n            cache.set(key, {\n              ...data,\n              staleAt: new Date(data.staleAt),\n            });\n          });\n        }\n        cleanupCache();\n      }\n    }\n  } catch (e) {\n    // Ignore localStorage errors\n  }\n  if (!cacheSettings.disableIdleStreams) {\n    const cleanupFn = helpers.startIdleListener();\n    if (cleanupFn) {\n      helpers.stopIdleListener = cleanupFn;\n    }\n  }\n}\n\n// Enforce the maxEntries limit\nfunction cleanupCache() {\n  const entriesWithTimestamps = Array.from(cache.entries())\n    .map(([key, value]) => ({\n      key,\n      staleAt: value.staleAt.getTime(),\n    }))\n    .sort((a, b) => a.staleAt - b.staleAt);\n\n  const entriesToRemoveCount = Math.min(\n    Math.max(0, cache.size - cacheSettings.maxEntries),\n    cache.size,\n  );\n\n  for (let i = 0; i < entriesToRemoveCount; i++) {\n    cache.delete(entriesWithTimestamps[i].key);\n  }\n}\n\n// Called whenever new features are fetched from the API\nfunction onNewFeatureData(\n  key: string,\n  cacheKey: string,\n  data: FeatureApiResponse,\n): void {\n  // If contents haven't changed, ignore the update, extend the stale TTL\n  const version = data.dateUpdated || \"\";\n  const staleAt = new Date(Date.now() + cacheSettings.staleTTL);\n  const existing = !cacheSettings.disableCache\n    ? cache.get(cacheKey)\n    : undefined;\n  if (existing && version && existing.version === version) {\n    existing.staleAt = staleAt;\n    updatePersistentCache();\n    return;\n  }\n\n  if (!cacheSettings.disableCache) {\n    // Update in-memory cache\n    cache.set(cacheKey, {\n      data,\n      version,\n      staleAt,\n      sse: supportsSSE.has(key),\n    });\n    cleanupCache();\n  }\n  // Update local storage (don't await this, just update asynchronously)\n  updatePersistentCache();\n\n  // Update features for all subscribed GrowthBook instances\n  const instances = subscribedInstances.get(key);\n  instances && instances.forEach((instance) => refreshInstance(instance, data));\n}\n\nasync function refreshInstance(\n  instance: GrowthBook | GrowthBookClient,\n  data: FeatureApiResponse | null,\n): Promise<void> {\n  await instance.setPayload(data || instance.getPayload());\n}\n\n// Fetch the features payload from helper function or from in-mem injected payload\nasync function fetchFeatures(\n  instance: GrowthBook | GrowthBookClient,\n): Promise<FetchResponse> {\n  const { apiHost, apiRequestHeaders } = instance.getApiHosts();\n  const clientKey = instance.getClientKey();\n  const remoteEval = \"isRemoteEval\" in instance && instance.isRemoteEval();\n  const key = getKey(instance);\n  const cacheKey = getCacheKey(instance);\n\n  let promise = activeFetches.get(cacheKey);\n  if (!promise) {\n    const fetcher: Promise<Response> = remoteEval\n      ? helpers.fetchRemoteEvalCall({\n          host: apiHost,\n          clientKey,\n          payload: {\n            attributes: instance.getAttributes(),\n            forcedVariations: instance.getForcedVariations(),\n            forcedFeatures: Array.from(instance.getForcedFeatures().entries()),\n            url: instance.getUrl(),\n          },\n          headers: apiRequestHeaders,\n        })\n      : helpers.fetchFeaturesCall({\n          host: apiHost,\n          clientKey,\n          headers: apiRequestHeaders,\n        });\n\n    // TODO: auto-retry if status code indicates a temporary error\n    promise = fetcher\n      .then((res) => {\n        if (!res.ok) {\n          throw new Error(`HTTP error: ${res.status}`);\n        }\n        if (res.headers.get(\"x-sse-support\") === \"enabled\") {\n          supportsSSE.add(key);\n        }\n        return res.json();\n      })\n      .then((data: FeatureApiResponse) => {\n        onNewFeatureData(key, cacheKey, data);\n        startAutoRefresh(instance);\n        activeFetches.delete(cacheKey);\n        return { data, success: true, source: \"network\" as const };\n      })\n      .catch((e) => {\n        process.env.NODE_ENV !== \"production\" &&\n          instance.log(\"Error fetching features\", {\n            apiHost,\n            clientKey,\n            error: e ? e.message : null,\n          });\n        activeFetches.delete(cacheKey);\n\n        return {\n          data: null,\n          source: \"error\" as const,\n          success: false,\n          error: e,\n        };\n      });\n    activeFetches.set(cacheKey, promise);\n  }\n  return promise;\n}\n\n// Start SSE streaming, listens to feature payload changes and triggers a refresh or re-fetch\nfunction startAutoRefresh(\n  instance: GrowthBook | GrowthBookClient,\n  forceSSE: boolean = false,\n): void {\n  const key = getKey(instance);\n  const cacheKey = getCacheKey(instance);\n  const { streamingHost, streamingHostRequestHeaders } = instance.getApiHosts();\n  const clientKey = instance.getClientKey();\n\n  if (forceSSE) {\n    supportsSSE.add(key);\n  }\n\n  if (\n    cacheSettings.backgroundSync &&\n    supportsSSE.has(key) &&\n    polyfills.EventSource\n  ) {\n    if (streams.has(key)) return;\n    const channel: ScopedChannel = {\n      src: null,\n      host: streamingHost,\n      clientKey,\n      headers: streamingHostRequestHeaders,\n      cb: (event: MessageEvent<string>) => {\n        try {\n          if (event.type === \"features-updated\") {\n            const instances = subscribedInstances.get(key);\n            instances &&\n              instances.forEach((instance) => {\n                fetchFeatures(instance);\n              });\n          } else if (event.type === \"features\") {\n            const json: FeatureApiResponse = JSON.parse(event.data);\n            onNewFeatureData(key, cacheKey, json);\n          }\n          // Reset error count on success\n          channel.errors = 0;\n        } catch (e) {\n          process.env.NODE_ENV !== \"production\" &&\n            instance.log(\"SSE Error\", {\n              streamingHost,\n              clientKey,\n              error: e ? (e as Error).message : null,\n            });\n          onSSEError(channel);\n        }\n      },\n      errors: 0,\n      state: \"active\",\n    };\n    streams.set(key, channel);\n    enableChannel(channel);\n  }\n}\n\nfunction onSSEError(channel: ScopedChannel) {\n  if (channel.state === \"idle\") return;\n  channel.errors++;\n  if (channel.errors > 3 || (channel.src && channel.src.readyState === 2)) {\n    // exponential backoff after 4 errors, with jitter\n    const delay =\n      Math.pow(3, channel.errors - 3) * (1000 + Math.random() * 1000);\n    disableChannel(channel);\n    setTimeout(\n      () => {\n        if ([\"idle\", \"active\"].includes(channel.state)) return;\n        enableChannel(channel);\n      },\n      Math.min(delay, 300000),\n    ); // 5 minutes max\n  }\n}\n\nfunction disableChannel(channel: ScopedChannel) {\n  if (!channel.src) return;\n  channel.src.onopen = null;\n  channel.src.onerror = null;\n  channel.src.close();\n  channel.src = null;\n  if (channel.state === \"active\") {\n    channel.state = \"disabled\";\n  }\n}\n\nfunction enableChannel(channel: ScopedChannel) {\n  channel.src = helpers.eventSourceCall({\n    host: channel.host,\n    clientKey: channel.clientKey,\n    headers: channel.headers,\n  }) as EventSource;\n  channel.state = \"active\";\n  channel.src.addEventListener(\"features\", channel.cb);\n  channel.src.addEventListener(\"features-updated\", channel.cb);\n  channel.src.onerror = () => onSSEError(channel);\n  channel.src.onopen = () => {\n    channel.errors = 0;\n  };\n}\n\nfunction destroyChannel(channel: ScopedChannel, key: string) {\n  disableChannel(channel);\n  streams.delete(key);\n}\n\nexport function clearAutoRefresh() {\n  // Clear list of which keys are auto-updated\n  supportsSSE.clear();\n\n  // Stop listening for any SSE events\n  streams.forEach(destroyChannel);\n\n  // Remove all references to GrowthBook instances\n  subscribedInstances.clear();\n\n  // Run the idle stream cleanup function\n  helpers.stopIdleListener();\n}\n\nexport function startStreaming(\n  instance: GrowthBook | GrowthBookClient,\n  options: InitOptions | InitSyncOptions,\n) {\n  if (options.streaming) {\n    if (!instance.getClientKey()) {\n      throw new Error(\"Must specify clientKey to enable streaming\");\n    }\n    if (options.payload) {\n      startAutoRefresh(instance, true);\n    }\n    subscribe(instance);\n  }\n}\n","var validAttributeName = /^[a-zA-Z:_][a-zA-Z0-9:_.-]*$/;\nvar nullController = {\n  revert: function revert() {}\n};\nvar elements = /*#__PURE__*/new Map();\nvar mutations = /*#__PURE__*/new Set();\n\nfunction getObserverInit(attr) {\n  return attr === 'html' ? {\n    childList: true,\n    subtree: true,\n    attributes: true,\n    characterData: true\n  } : {\n    childList: false,\n    subtree: false,\n    attributes: true,\n    attributeFilter: [attr]\n  };\n}\n\nfunction getElementRecord(element) {\n  var record = elements.get(element);\n\n  if (!record) {\n    record = {\n      element: element,\n      attributes: {}\n    };\n    elements.set(element, record);\n  }\n\n  return record;\n}\n\nfunction createElementPropertyRecord(el, attr, getCurrentValue, setValue, mutationRunner) {\n  var currentValue = getCurrentValue(el);\n  var record = {\n    isDirty: false,\n    originalValue: currentValue,\n    virtualValue: currentValue,\n    mutations: [],\n    el: el,\n    _positionTimeout: null,\n    observer: new MutationObserver(function () {\n      // enact a 1 second timeout that blocks subsequent firing of the\n      // observer until the timeout is complete. This will prevent multiple\n      // mutations from firing in quick succession, which can cause the\n      // mutation to be reverted before the DOM has a chance to update.\n      if (attr === 'position' && record._positionTimeout) return;else if (attr === 'position') record._positionTimeout = setTimeout(function () {\n        record._positionTimeout = null;\n      }, 1000);\n      var currentValue = getCurrentValue(el);\n      if (attr === 'position' && currentValue.parentNode === record.virtualValue.parentNode && currentValue.insertBeforeNode === record.virtualValue.insertBeforeNode) return;\n      if (currentValue === record.virtualValue) return;\n      record.originalValue = currentValue;\n      mutationRunner(record);\n    }),\n    mutationRunner: mutationRunner,\n    setValue: setValue,\n    getCurrentValue: getCurrentValue\n  };\n\n  if (attr === 'position' && el.parentNode) {\n    record.observer.observe(el.parentNode, {\n      childList: true,\n      subtree: true,\n      attributes: false,\n      characterData: false\n    });\n  } else {\n    record.observer.observe(el, getObserverInit(attr));\n  }\n\n  return record;\n}\n\nfunction queueIfNeeded(val, record) {\n  var currentVal = record.getCurrentValue(record.el);\n  record.virtualValue = val;\n\n  if (val && typeof val !== 'string') {\n    if (!currentVal || val.parentNode !== currentVal.parentNode || val.insertBeforeNode !== currentVal.insertBeforeNode) {\n      record.isDirty = true;\n      runDOMUpdates();\n    }\n  } else if (val !== currentVal) {\n    record.isDirty = true;\n    runDOMUpdates();\n  }\n}\n\nfunction htmlMutationRunner(record) {\n  var val = record.originalValue;\n  record.mutations.forEach(function (m) {\n    return val = m.mutate(val);\n  });\n  queueIfNeeded(getTransformedHTML(val), record);\n}\n\nfunction classMutationRunner(record) {\n  var val = new Set(record.originalValue.split(/\\s+/).filter(Boolean));\n  record.mutations.forEach(function (m) {\n    return m.mutate(val);\n  });\n  queueIfNeeded(Array.from(val).filter(Boolean).join(' '), record);\n}\n\nfunction attrMutationRunner(record) {\n  var val = record.originalValue;\n  record.mutations.forEach(function (m) {\n    return val = m.mutate(val);\n  });\n  queueIfNeeded(val, record);\n}\n\nfunction _loadDOMNodes(_ref) {\n  var parentSelector = _ref.parentSelector,\n      insertBeforeSelector = _ref.insertBeforeSelector;\n  var parentNode = document.querySelector(parentSelector);\n  if (!parentNode) return null;\n  var insertBeforeNode = insertBeforeSelector ? document.querySelector(insertBeforeSelector) : null;\n  if (insertBeforeSelector && !insertBeforeNode) return null;\n  return {\n    parentNode: parentNode,\n    insertBeforeNode: insertBeforeNode\n  };\n}\n\nfunction positionMutationRunner(record) {\n  var val = record.originalValue;\n  record.mutations.forEach(function (m) {\n    var selectors = m.mutate();\n\n    var newNodes = _loadDOMNodes(selectors);\n\n    val = newNodes || val;\n  });\n  queueIfNeeded(val, record);\n}\n\nvar getHTMLValue = function getHTMLValue(el) {\n  return el.innerHTML;\n};\n\nvar setHTMLValue = function setHTMLValue(el, value) {\n  return el.innerHTML = value;\n};\n\nfunction getElementHTMLRecord(element) {\n  var elementRecord = getElementRecord(element);\n\n  if (!elementRecord.html) {\n    elementRecord.html = createElementPropertyRecord(element, 'html', getHTMLValue, setHTMLValue, htmlMutationRunner);\n  }\n\n  return elementRecord.html;\n}\n\nvar getElementPosition = function getElementPosition(el) {\n  return {\n    parentNode: el.parentElement,\n    insertBeforeNode: el.nextElementSibling\n  };\n};\n\nvar setElementPosition = function setElementPosition(el, value) {\n  if (value.insertBeforeNode && !value.parentNode.contains(value.insertBeforeNode)) {\n    // skip position mutation - insertBeforeNode not a child of parent. happens\n    // when mutation observer for indvidual element fires out of order\n    return;\n  }\n\n  value.parentNode.insertBefore(el, value.insertBeforeNode);\n};\n\nfunction getElementPositionRecord(element) {\n  var elementRecord = getElementRecord(element);\n\n  if (!elementRecord.position) {\n    elementRecord.position = createElementPropertyRecord(element, 'position', getElementPosition, setElementPosition, positionMutationRunner);\n  }\n\n  return elementRecord.position;\n}\n\nvar setClassValue = function setClassValue(el, val) {\n  return val ? el.className = val : el.removeAttribute('class');\n};\n\nvar getClassValue = function getClassValue(el) {\n  return el.className;\n};\n\nfunction getElementClassRecord(el) {\n  var elementRecord = getElementRecord(el);\n\n  if (!elementRecord.classes) {\n    elementRecord.classes = createElementPropertyRecord(el, 'class', getClassValue, setClassValue, classMutationRunner);\n  }\n\n  return elementRecord.classes;\n}\n\nvar getAttrValue = function getAttrValue(attrName) {\n  return function (el) {\n    var _el$getAttribute;\n\n    return (_el$getAttribute = el.getAttribute(attrName)) != null ? _el$getAttribute : null;\n  };\n};\n\nvar setAttrValue = function setAttrValue(attrName) {\n  return function (el, val) {\n    return val !== null ? el.setAttribute(attrName, val) : el.removeAttribute(attrName);\n  };\n};\n\nfunction getElementAttributeRecord(el, attr) {\n  var elementRecord = getElementRecord(el);\n\n  if (!elementRecord.attributes[attr]) {\n    elementRecord.attributes[attr] = createElementPropertyRecord(el, attr, getAttrValue(attr), setAttrValue(attr), attrMutationRunner);\n  }\n\n  return elementRecord.attributes[attr];\n}\n\nfunction deleteElementPropertyRecord(el, attr) {\n  var element = elements.get(el);\n  if (!element) return;\n\n  if (attr === 'html') {\n    var _element$html, _element$html$observe;\n\n    (_element$html = element.html) == null ? void 0 : (_element$html$observe = _element$html.observer) == null ? void 0 : _element$html$observe.disconnect();\n    delete element.html;\n  } else if (attr === 'class') {\n    var _element$classes, _element$classes$obse;\n\n    (_element$classes = element.classes) == null ? void 0 : (_element$classes$obse = _element$classes.observer) == null ? void 0 : _element$classes$obse.disconnect();\n    delete element.classes;\n  } else if (attr === 'position') {\n    var _element$position, _element$position$obs;\n\n    (_element$position = element.position) == null ? void 0 : (_element$position$obs = _element$position.observer) == null ? void 0 : _element$position$obs.disconnect();\n    delete element.position;\n  } else {\n    var _element$attributes, _element$attributes$a, _element$attributes$a2;\n\n    (_element$attributes = element.attributes) == null ? void 0 : (_element$attributes$a = _element$attributes[attr]) == null ? void 0 : (_element$attributes$a2 = _element$attributes$a.observer) == null ? void 0 : _element$attributes$a2.disconnect();\n    delete element.attributes[attr];\n  }\n}\n\nvar transformContainer;\n\nfunction getTransformedHTML(html) {\n  if (!transformContainer) {\n    transformContainer = document.createElement('div');\n  }\n\n  transformContainer.innerHTML = html;\n  return transformContainer.innerHTML;\n}\n\nfunction setPropertyValue(el, attr, m) {\n  if (!m.isDirty) return;\n  m.isDirty = false;\n  var val = m.virtualValue;\n\n  if (!m.mutations.length) {\n    deleteElementPropertyRecord(el, attr);\n  }\n\n  m.setValue(el, val);\n}\n\nfunction setValue(m, el) {\n  m.html && setPropertyValue(el, 'html', m.html);\n  m.classes && setPropertyValue(el, 'class', m.classes);\n  m.position && setPropertyValue(el, 'position', m.position);\n  Object.keys(m.attributes).forEach(function (attr) {\n    setPropertyValue(el, attr, m.attributes[attr]);\n  });\n}\n\nfunction runDOMUpdates() {\n  elements.forEach(setValue);\n} // find or create ElementPropertyRecord, add mutation to it, then run\n\n\nfunction startMutating(mutation, element) {\n  var record = null;\n\n  if (mutation.kind === 'html') {\n    record = getElementHTMLRecord(element);\n  } else if (mutation.kind === 'class') {\n    record = getElementClassRecord(element);\n  } else if (mutation.kind === 'attribute') {\n    record = getElementAttributeRecord(element, mutation.attribute);\n  } else if (mutation.kind === 'position') {\n    record = getElementPositionRecord(element);\n  }\n\n  if (!record) return;\n  record.mutations.push(mutation);\n  record.mutationRunner(record);\n} // get (existing) ElementPropertyRecord, remove mutation from it, then run\n\n\nfunction stopMutating(mutation, el) {\n  var record = null;\n\n  if (mutation.kind === 'html') {\n    record = getElementHTMLRecord(el);\n  } else if (mutation.kind === 'class') {\n    record = getElementClassRecord(el);\n  } else if (mutation.kind === 'attribute') {\n    record = getElementAttributeRecord(el, mutation.attribute);\n  } else if (mutation.kind === 'position') {\n    record = getElementPositionRecord(el);\n  }\n\n  if (!record) return;\n  var index = record.mutations.indexOf(mutation);\n  if (index !== -1) record.mutations.splice(index, 1);\n  record.mutationRunner(record);\n} // maintain list of elements associated with mutation\n\n\nfunction refreshElementsSet(mutation) {\n  // if a position mutation has already found an element to move, don't move\n  // any more elements\n  if (mutation.kind === 'position' && mutation.elements.size === 1) return;\n  var existingElements = new Set(mutation.elements);\n  var matchingElements = document.querySelectorAll(mutation.selector);\n  matchingElements.forEach(function (el) {\n    if (!existingElements.has(el)) {\n      mutation.elements.add(el);\n      startMutating(mutation, el);\n    }\n  });\n}\n\nfunction revertMutation(mutation) {\n  mutation.elements.forEach(function (el) {\n    return stopMutating(mutation, el);\n  });\n  mutation.elements.clear();\n  mutations[\"delete\"](mutation);\n}\n\nfunction refreshAllElementSets() {\n  mutations.forEach(refreshElementsSet);\n} // Observer for elements that don't exist in the DOM yet\n\n\nvar observer;\nfunction disconnectGlobalObserver() {\n  observer && observer.disconnect();\n}\nfunction connectGlobalObserver() {\n  if (typeof document === 'undefined') return;\n\n  if (!observer) {\n    observer = new MutationObserver(function () {\n      refreshAllElementSets();\n    });\n  }\n\n  refreshAllElementSets();\n  observer.observe(document.documentElement, {\n    childList: true,\n    subtree: true,\n    attributes: false,\n    characterData: false\n  });\n} // run on init\n\nconnectGlobalObserver();\n\nfunction newMutation(m) {\n  // Not in a browser\n  if (typeof document === 'undefined') return nullController; // add to global index of mutations\n\n  mutations.add(m); // run refresh on init to establish list of elements associated w/ mutation\n\n  refreshElementsSet(m);\n  return {\n    revert: function revert() {\n      revertMutation(m);\n    }\n  };\n}\n\nfunction html(selector, mutate) {\n  return newMutation({\n    kind: 'html',\n    elements: new Set(),\n    mutate: mutate,\n    selector: selector\n  });\n}\n\nfunction position(selector, mutate) {\n  return newMutation({\n    kind: 'position',\n    elements: new Set(),\n    mutate: mutate,\n    selector: selector\n  });\n}\n\nfunction classes(selector, mutate) {\n  return newMutation({\n    kind: 'class',\n    elements: new Set(),\n    mutate: mutate,\n    selector: selector\n  });\n}\n\nfunction attribute(selector, attribute, mutate) {\n  if (!validAttributeName.test(attribute)) return nullController;\n\n  if (attribute === 'class' || attribute === 'className') {\n    return classes(selector, function (classnames) {\n      var mutatedClassnames = mutate(Array.from(classnames).join(' '));\n      classnames.clear();\n      if (!mutatedClassnames) return;\n      mutatedClassnames.split(/\\s+/g).filter(Boolean).forEach(function (c) {\n        return classnames.add(c);\n      });\n    });\n  }\n\n  return newMutation({\n    kind: 'attribute',\n    attribute: attribute,\n    elements: new Set(),\n    mutate: mutate,\n    selector: selector\n  });\n}\n\nfunction declarative(_ref2) {\n  var selector = _ref2.selector,\n      action = _ref2.action,\n      value = _ref2.value,\n      attr = _ref2.attribute,\n      parentSelector = _ref2.parentSelector,\n      insertBeforeSelector = _ref2.insertBeforeSelector;\n\n  if (attr === 'html') {\n    if (action === 'append') {\n      return html(selector, function (val) {\n        return val + (value != null ? value : '');\n      });\n    } else if (action === 'set') {\n      return html(selector, function () {\n        return value != null ? value : '';\n      });\n    }\n  } else if (attr === 'class') {\n    if (action === 'append') {\n      return classes(selector, function (val) {\n        if (value) val.add(value);\n      });\n    } else if (action === 'remove') {\n      return classes(selector, function (val) {\n        if (value) val[\"delete\"](value);\n      });\n    } else if (action === 'set') {\n      return classes(selector, function (val) {\n        val.clear();\n        if (value) val.add(value);\n      });\n    }\n  } else if (attr === 'position') {\n    if (action === 'set' && parentSelector) {\n      return position(selector, function () {\n        return {\n          insertBeforeSelector: insertBeforeSelector,\n          parentSelector: parentSelector\n        };\n      });\n    }\n  } else {\n    if (action === 'append') {\n      return attribute(selector, attr, function (val) {\n        return val !== null ? val + (value != null ? value : '') : value != null ? value : '';\n      });\n    } else if (action === 'set') {\n      return attribute(selector, attr, function () {\n        return value != null ? value : '';\n      });\n    } else if (action === 'remove') {\n      return attribute(selector, attr, function () {\n        return null;\n      });\n    }\n  }\n\n  return nullController;\n}\n\nvar index = {\n  html: html,\n  classes: classes,\n  attribute: attribute,\n  position: position,\n  declarative: declarative\n};\n\nexport default index;\nexport { connectGlobalObserver, disconnectGlobalObserver, validAttributeName };\n//# sourceMappingURL=dom-mutator.esm.js.map\n","/* eslint-disable @typescript-eslint/no-explicit-any */\n\nimport { SavedGroupsValues } from \"./types/growthbook\";\nimport {\n  ConditionInterface,\n  TestedObj,\n  ConditionValue,\n  Operator,\n  OperatorConditionValue,\n  VarType,\n} from \"./types/mongrule\";\nimport { paddedVersionString } from \"./util\";\n\nconst _regexCache: { [key: string]: RegExp } = {};\n\n// The top-level condition evaluation function\nexport function evalCondition(\n  obj: TestedObj,\n  condition: ConditionInterface,\n  // Must be included for `condition` to correctly evaluate group Operators\n  savedGroups?: SavedGroupsValues,\n): boolean {\n  savedGroups = savedGroups || {};\n  // Condition is an object, keys are either specific operators or object paths\n  // values are either arguments for operators or conditions for paths\n  for (const [k, v] of Object.entries(condition)) {\n    switch (k) {\n      case \"$or\":\n        if (!evalOr(obj, v as ConditionInterface[], savedGroups)) return false;\n        break;\n      case \"$nor\":\n        if (evalOr(obj, v as ConditionInterface[], savedGroups)) return false;\n        break;\n      case \"$and\":\n        if (!evalAnd(obj, v as ConditionInterface[], savedGroups)) return false;\n        break;\n      case \"$not\":\n        if (evalCondition(obj, v as ConditionInterface, savedGroups))\n          return false;\n        break;\n      default:\n        if (!evalConditionValue(v, getPath(obj, k), savedGroups)) return false;\n    }\n  }\n  return true;\n}\n\n// Return value at dot-separated path of an object\nfunction getPath(obj: TestedObj, path: string) {\n  const parts = path.split(\".\");\n  let current: any = obj;\n  for (let i = 0; i < parts.length; i++) {\n    if (current && typeof current === \"object\" && parts[i] in current) {\n      current = current[parts[i]];\n    } else {\n      return null;\n    }\n  }\n  return current;\n}\n\n// Transform a regex string into a real RegExp object\nfunction getRegex(regex: string, insensitive = false): RegExp {\n  const cacheKey = `${regex}${insensitive ? \"/i\" : \"\"}`;\n  if (!_regexCache[cacheKey]) {\n    _regexCache[cacheKey] = new RegExp(\n      regex.replace(/([^\\\\])\\//g, \"$1\\\\/\"),\n      insensitive ? \"i\" : undefined,\n    );\n  }\n  return _regexCache[cacheKey];\n}\n\n// Evaluate a single value against a condition\nfunction evalConditionValue(\n  condition: ConditionValue,\n  value: any,\n  savedGroups: SavedGroupsValues,\n  insensitive: boolean = false,\n) {\n  // Simple equality comparisons\n  if (typeof condition === \"string\") {\n    if (insensitive) {\n      return String(value).toLowerCase() === condition.toLowerCase();\n    }\n    return value + \"\" === condition;\n  }\n  if (typeof condition === \"number\") {\n    return value * 1 === condition;\n  }\n  if (typeof condition === \"boolean\") {\n    return value !== null && !!value === condition;\n  }\n\n  if (condition === null) {\n    return value === null;\n  }\n\n  if (Array.isArray(condition) || !isOperatorObject(condition)) {\n    return JSON.stringify(value) === JSON.stringify(condition);\n  }\n\n  // This is a special operator condition and we should evaluate each one separately\n  for (const op in condition) {\n    if (\n      !evalOperatorCondition(\n        op as Operator,\n        value,\n        condition[op as keyof OperatorConditionValue],\n        savedGroups,\n      )\n    ) {\n      return false;\n    }\n  }\n  return true;\n}\n\n// If the object has only keys that start with '$'\nfunction isOperatorObject(obj: any): boolean {\n  const keys = Object.keys(obj);\n  return (\n    keys.length > 0 && keys.filter((k) => k[0] === \"$\").length === keys.length\n  );\n}\n\n// Return the data type of a value\nfunction getType(v: any): VarType | \"unknown\" {\n  if (v === null) return \"null\";\n  if (Array.isArray(v)) return \"array\";\n  const t = typeof v;\n  if ([\"string\", \"number\", \"boolean\", \"object\", \"undefined\"].includes(t)) {\n    return t as VarType;\n  }\n  return \"unknown\";\n}\n\n// At least one element of actual must match the expected condition/value\nfunction elemMatch(actual: any, expected: any, savedGroups: SavedGroupsValues) {\n  if (!Array.isArray(actual)) return false;\n  const check = isOperatorObject(expected)\n    ? (v: any) => evalConditionValue(expected, v, savedGroups)\n    : (v: any) => evalCondition(v, expected, savedGroups);\n  for (let i = 0; i < actual.length; i++) {\n    if (actual[i] && check(actual[i])) {\n      return true;\n    }\n  }\n  return false;\n}\n\nfunction isIn(\n  actual: any,\n  expected: Array<any>,\n  insensitive: boolean = false,\n): boolean {\n  if (insensitive) {\n    const caseFold = (val: any) =>\n      typeof val === \"string\" ? val.toLowerCase() : val;\n    // Do an intersection if attribute is an array (insensitive)\n    if (Array.isArray(actual)) {\n      return actual.some((el) =>\n        expected.some((exp) => caseFold(el) === caseFold(exp)),\n      );\n    }\n    return expected.some((exp) => caseFold(actual) === caseFold(exp));\n  }\n  // Do an intersection if attribute is an array\n  if (Array.isArray(actual)) {\n    return actual.some((el) => expected.includes(el));\n  }\n  return expected.includes(actual);\n}\n\nfunction isInAll(\n  actual: any,\n  expected: ConditionValue[],\n  savedGroups: SavedGroupsValues,\n  insensitive: boolean = false,\n): boolean {\n  if (!Array.isArray(actual)) return false;\n  for (let i = 0; i < expected.length; i++) {\n    let passed = false;\n    for (let j = 0; j < actual.length; j++) {\n      if (\n        evalConditionValue(expected[i], actual[j], savedGroups, insensitive)\n      ) {\n        passed = true;\n        break;\n      }\n    }\n    if (!passed) return false;\n  }\n  return true;\n}\n\n// Evaluate a single operator condition\nfunction evalOperatorCondition(\n  operator: Operator,\n  actual: any,\n  expected: any,\n  savedGroups: SavedGroupsValues,\n): boolean {\n  switch (operator) {\n    case \"$veq\":\n      return paddedVersionString(actual) === paddedVersionString(expected);\n    case \"$vne\":\n      return paddedVersionString(actual) !== paddedVersionString(expected);\n    case \"$vgt\":\n      return paddedVersionString(actual) > paddedVersionString(expected);\n    case \"$vgte\":\n      return paddedVersionString(actual) >= paddedVersionString(expected);\n    case \"$vlt\":\n      return paddedVersionString(actual) < paddedVersionString(expected);\n    case \"$vlte\":\n      return paddedVersionString(actual) <= paddedVersionString(expected);\n    case \"$eq\":\n      return actual === expected;\n    case \"$ne\":\n      return actual !== expected;\n    case \"$lt\":\n      return actual < expected;\n    case \"$lte\":\n      return actual <= expected;\n    case \"$gt\":\n      return actual > expected;\n    case \"$gte\":\n      return actual >= expected;\n    case \"$exists\":\n      // Using `!=` and `==` instead of strict checks so it also matches for undefined\n      return expected ? actual != null : actual == null;\n    case \"$in\":\n      if (!Array.isArray(expected)) return false;\n      return isIn(actual, expected);\n    case \"$ini\":\n      if (!Array.isArray(expected)) return false;\n      return isIn(actual, expected, true);\n    case \"$inGroup\":\n      return isIn(actual, savedGroups[expected] || []);\n    case \"$notInGroup\":\n      return !isIn(actual, savedGroups[expected] || []);\n    case \"$nin\":\n      if (!Array.isArray(expected)) return false;\n      return !isIn(actual, expected);\n    case \"$nini\":\n      if (!Array.isArray(expected)) return false;\n      return !isIn(actual, expected, true);\n    case \"$not\":\n      return !evalConditionValue(expected, actual, savedGroups);\n    case \"$size\":\n      if (!Array.isArray(actual)) return false;\n      return evalConditionValue(expected, actual.length, savedGroups);\n    case \"$elemMatch\":\n      return elemMatch(actual, expected, savedGroups);\n    case \"$all\":\n      if (!Array.isArray(expected)) return false;\n      return isInAll(actual, expected, savedGroups);\n    case \"$alli\":\n      if (!Array.isArray(expected)) return false;\n      return isInAll(actual, expected, savedGroups, true);\n    case \"$regex\":\n      try {\n        return getRegex(expected).test(actual);\n      } catch (e) {\n        return false;\n      }\n    case \"$regexi\":\n      try {\n        return getRegex(expected, true).test(actual);\n      } catch (e) {\n        return false;\n      }\n    case \"$type\":\n      return getType(actual) === expected;\n    default:\n      console.error(\"Unknown operator: \" + operator);\n      return false;\n  }\n}\n\n// Recursive $or rule\nfunction evalOr(\n  obj: TestedObj,\n  conditions: ConditionInterface[],\n  savedGroups: SavedGroupsValues,\n): boolean {\n  if (!conditions.length) return true;\n  for (let i = 0; i < conditions.length; i++) {\n    if (evalCondition(obj, conditions[i], savedGroups)) {\n      return true;\n    }\n  }\n  return false;\n}\n\n// Recursive $and rule\nfunction evalAnd(\n  obj: TestedObj,\n  conditions: ConditionInterface[],\n  savedGroups: SavedGroupsValues,\n): boolean {\n  for (let i = 0; i < conditions.length; i++) {\n    if (!evalCondition(obj, conditions[i], savedGroups)) {\n      return false;\n    }\n  }\n  return true;\n}\n","import {\n  EvalContext,\n  FeatureDefinition,\n  FeatureResult,\n  Experiment,\n  FeatureResultSource,\n  Result,\n  Filter,\n  VariationRange,\n  VariationMeta,\n  StickyExperimentKey,\n  StickyAssignments,\n  StickyAttributeKey,\n  StickyAssignmentsDocument,\n  FeatureApiResponse,\n  Options,\n  ClientOptions,\n} from \"./types/growthbook\";\nimport { evalCondition } from \"./mongrule\";\nimport { ConditionInterface } from \"./types/mongrule\";\nimport {\n  chooseVariation,\n  decrypt,\n  getBucketRanges,\n  getQueryStringOverride,\n  getUrlRegExp,\n  hash,\n  inNamespace,\n  inRange,\n  isIncluded,\n  isURLTargeted,\n  toString,\n} from \"./util\";\nimport { StickyBucketService } from \"./sticky-bucket-service\";\n\nexport const EVENT_FEATURE_EVALUATED = \"Feature Evaluated\";\nexport const EVENT_EXPERIMENT_VIEWED = \"Experiment Viewed\";\n\nfunction getForcedFeatureValues(ctx: EvalContext) {\n  // Merge user and global values\n  const ret: typeof ctx.global.forcedFeatureValues = new Map();\n  if (ctx.global.forcedFeatureValues) {\n    ctx.global.forcedFeatureValues.forEach((v, k) => ret.set(k, v));\n  }\n  if (ctx.user.forcedFeatureValues) {\n    ctx.user.forcedFeatureValues.forEach((v, k) => ret.set(k, v));\n  }\n  return ret;\n}\n\nfunction getForcedVariations(ctx: EvalContext) {\n  // Merge user and global values\n  if (ctx.global.forcedVariations && ctx.user.forcedVariations) {\n    return { ...ctx.global.forcedVariations, ...ctx.user.forcedVariations };\n  } else if (ctx.global.forcedVariations) {\n    return ctx.global.forcedVariations;\n  } else if (ctx.user.forcedVariations) {\n    return ctx.user.forcedVariations;\n  } else {\n    return {};\n  }\n}\n\nasync function safeCall(fn: () => void | Promise<void>) {\n  try {\n    await fn();\n  } catch (e) {\n    // Do nothing\n  }\n}\n\nfunction onExperimentViewed(\n  ctx: EvalContext,\n  experiment: Experiment<unknown>,\n  result: Result<unknown>,\n): Promise<void>[] {\n  // Make sure a tracking callback is only fired once per unique experiment\n  if (ctx.user.trackedExperiments) {\n    const k = getExperimentDedupeKey(experiment, result);\n    if (ctx.user.trackedExperiments.has(k)) {\n      return [];\n    }\n    ctx.user.trackedExperiments.add(k);\n  }\n\n  if (ctx.user.enableDevMode && ctx.user.devLogs) {\n    ctx.user.devLogs.push({\n      experiment,\n      result,\n      timestamp: Date.now().toString(),\n      logType: \"experiment\",\n    });\n  }\n\n  const calls: Promise<void>[] = [];\n\n  if (ctx.global.trackingCallback) {\n    const cb = ctx.global.trackingCallback;\n    calls.push(safeCall(() => cb(experiment, result, ctx.user)));\n  }\n  if (ctx.user.trackingCallback) {\n    const cb = ctx.user.trackingCallback;\n    calls.push(safeCall(() => cb(experiment, result)));\n  }\n  if (ctx.global.eventLogger) {\n    const cb = ctx.global.eventLogger;\n    calls.push(\n      safeCall(() =>\n        cb(\n          EVENT_EXPERIMENT_VIEWED,\n          {\n            experimentId: experiment.key,\n            variationId: result.key,\n            hashAttribute: result.hashAttribute,\n            hashValue: result.hashValue,\n          },\n          ctx.user,\n        ),\n      ),\n    );\n  }\n  return calls;\n}\n\nfunction onFeatureUsage(\n  ctx: EvalContext,\n  key: string,\n  ret: FeatureResult<unknown>,\n): void {\n  // Only track a feature once, unless the assigned value changed\n  if (ctx.user.trackedFeatureUsage) {\n    const stringifiedValue = JSON.stringify(ret.value);\n    if (ctx.user.trackedFeatureUsage[key] === stringifiedValue) return;\n    ctx.user.trackedFeatureUsage[key] = stringifiedValue;\n\n    if (ctx.user.enableDevMode && ctx.user.devLogs) {\n      ctx.user.devLogs.push({\n        featureKey: key,\n        result: ret,\n        timestamp: Date.now().toString(),\n        logType: \"feature\",\n      });\n    }\n  }\n\n  if (ctx.global.onFeatureUsage) {\n    const cb = ctx.global.onFeatureUsage;\n    safeCall(() => cb(key, ret, ctx.user));\n  }\n  if (ctx.user.onFeatureUsage) {\n    const cb = ctx.user.onFeatureUsage;\n    safeCall(() => cb(key, ret));\n  }\n  if (ctx.global.eventLogger) {\n    const cb = ctx.global.eventLogger;\n    safeCall(() =>\n      cb(\n        EVENT_FEATURE_EVALUATED,\n        {\n          feature: key,\n          source: ret.source,\n          value: ret.value,\n          ruleId: ret.source === \"defaultValue\" ? \"$default\" : ret.ruleId || \"\",\n          variationId: ret.experimentResult ? ret.experimentResult.key : \"\",\n        },\n        ctx.user,\n      ),\n    );\n  }\n}\n\nexport function evalFeature<V = unknown>(\n  id: string,\n  ctx: EvalContext,\n): FeatureResult<V | null> {\n  if (ctx.stack.evaluatedFeatures.has(id)) {\n    process.env.NODE_ENV !== \"production\" &&\n      ctx.global.log(\n        `evalFeature: circular dependency detected: ${ctx.stack.id} -> ${id}`,\n        {\n          from: ctx.stack.id,\n          to: id,\n        },\n      );\n    return getFeatureResult(ctx, id, null, \"cyclicPrerequisite\");\n  }\n  ctx.stack.evaluatedFeatures.add(id);\n  ctx.stack.id = id;\n\n  // Global override\n  const forcedValues = getForcedFeatureValues(ctx);\n  if (forcedValues.has(id)) {\n    process.env.NODE_ENV !== \"production\" &&\n      ctx.global.log(\"Global override\", {\n        id,\n        value: forcedValues.get(id),\n      });\n    return getFeatureResult(ctx, id, forcedValues.get(id), \"override\");\n  }\n\n  // Unknown feature id\n  if (!ctx.global.features || !ctx.global.features[id]) {\n    process.env.NODE_ENV !== \"production\" &&\n      ctx.global.log(\"Unknown feature\", { id });\n    return getFeatureResult(ctx, id, null, \"unknownFeature\");\n  }\n\n  // Get the feature\n  const feature: FeatureDefinition<V> = ctx.global.features[id];\n\n  // Loop through the rules\n  if (feature.rules) {\n    const evaluatedFeatures = new Set(ctx.stack.evaluatedFeatures);\n    rules: for (const rule of feature.rules) {\n      // If there are prerequisite flag(s), evaluate them\n      if (rule.parentConditions) {\n        for (const parentCondition of rule.parentConditions) {\n          ctx.stack.evaluatedFeatures = new Set(evaluatedFeatures);\n          const parentResult = evalFeature(parentCondition.id, ctx);\n          // break out for cyclic prerequisites\n          if (parentResult.source === \"cyclicPrerequisite\") {\n            return getFeatureResult(ctx, id, null, \"cyclicPrerequisite\");\n          }\n\n          const evalObj = { value: parentResult.value };\n          const evaled = evalCondition(\n            evalObj,\n            parentCondition.condition || {},\n          );\n          if (!evaled) {\n            // blocking prerequisite eval failed: feature evaluation fails\n            if (parentCondition.gate) {\n              process.env.NODE_ENV !== \"production\" &&\n                ctx.global.log(\"Feature blocked by prerequisite\", { id, rule });\n              return getFeatureResult(ctx, id, null, \"prerequisite\");\n            }\n            // non-blocking prerequisite eval failed: break out of parentConditions loop, jump to the next rule\n            process.env.NODE_ENV !== \"production\" &&\n              ctx.global.log(\n                \"Skip rule because prerequisite evaluation fails\",\n                {\n                  id,\n                  rule,\n                },\n              );\n            continue rules;\n          }\n        }\n      }\n\n      // If there are filters for who is included (e.g. namespaces)\n      if (rule.filters && isFilteredOut(rule.filters, ctx)) {\n        process.env.NODE_ENV !== \"production\" &&\n          ctx.global.log(\"Skip rule because of filters\", {\n            id,\n            rule,\n          });\n        continue;\n      }\n\n      // Feature value is being forced\n      if (\"force\" in rule) {\n        // If it's a conditional rule, skip if the condition doesn't pass\n        if (rule.condition && !conditionPasses(rule.condition, ctx)) {\n          process.env.NODE_ENV !== \"production\" &&\n            ctx.global.log(\"Skip rule because of condition ff\", {\n              id,\n              rule,\n            });\n          continue;\n        }\n\n        // If this is a percentage rollout, skip if not included\n        if (\n          !isIncludedInRollout(\n            ctx,\n            rule.seed || id,\n            rule.hashAttribute,\n            ctx.user.saveStickyBucketAssignmentDoc &&\n              !rule.disableStickyBucketing\n              ? rule.fallbackAttribute\n              : undefined,\n            rule.range,\n            rule.coverage,\n            rule.hashVersion,\n          )\n        ) {\n          process.env.NODE_ENV !== \"production\" &&\n            ctx.global.log(\"Skip rule because user not included in rollout\", {\n              id,\n              rule,\n            });\n          continue;\n        }\n\n        process.env.NODE_ENV !== \"production\" &&\n          ctx.global.log(\"Force value from rule\", {\n            id,\n            rule,\n          });\n\n        // If this was a remotely evaluated experiment, fire the tracking callbacks\n        if (rule.tracks) {\n          rule.tracks.forEach((t) => {\n            const calls = onExperimentViewed(ctx, t.experiment, t.result);\n            if (!calls.length && ctx.global.saveDeferredTrack) {\n              ctx.global.saveDeferredTrack({\n                experiment: t.experiment,\n                result: t.result,\n              });\n            }\n          });\n        }\n\n        return getFeatureResult(ctx, id, rule.force as V, \"force\", rule.id);\n      }\n      if (!rule.variations) {\n        process.env.NODE_ENV !== \"production\" &&\n          ctx.global.log(\"Skip invalid rule\", {\n            id,\n            rule,\n          });\n\n        continue;\n      }\n\n      // For experiment rules, run an experiment\n      const exp: Experiment<V> = {\n        variations: rule.variations as [V, V, ...V[]],\n        key: rule.key || id,\n      };\n      if (\"coverage\" in rule) exp.coverage = rule.coverage;\n      if (rule.weights) exp.weights = rule.weights;\n      if (rule.hashAttribute) exp.hashAttribute = rule.hashAttribute;\n      if (rule.fallbackAttribute)\n        exp.fallbackAttribute = rule.fallbackAttribute;\n      if (rule.disableStickyBucketing)\n        exp.disableStickyBucketing = rule.disableStickyBucketing;\n      if (rule.bucketVersion !== undefined)\n        exp.bucketVersion = rule.bucketVersion;\n      if (rule.minBucketVersion !== undefined)\n        exp.minBucketVersion = rule.minBucketVersion;\n      if (rule.namespace) exp.namespace = rule.namespace;\n      if (rule.meta) exp.meta = rule.meta;\n      if (rule.ranges) exp.ranges = rule.ranges;\n      if (rule.name) exp.name = rule.name;\n      if (rule.phase) exp.phase = rule.phase;\n      if (rule.seed) exp.seed = rule.seed;\n      if (rule.hashVersion) exp.hashVersion = rule.hashVersion;\n      if (rule.filters) exp.filters = rule.filters;\n      if (rule.condition) exp.condition = rule.condition;\n\n      // Only return a value if the user is part of the experiment\n      const { result } = runExperiment(exp, id, ctx);\n      ctx.global.onExperimentEval && ctx.global.onExperimentEval(exp, result);\n      if (result.inExperiment && !result.passthrough) {\n        return getFeatureResult(\n          ctx,\n          id,\n          result.value,\n          \"experiment\",\n          rule.id,\n          exp,\n          result,\n        );\n      }\n    }\n  }\n\n  process.env.NODE_ENV !== \"production\" &&\n    ctx.global.log(\"Use default value\", {\n      id,\n      value: feature.defaultValue,\n    });\n\n  // Fall back to using the default value\n  return getFeatureResult(\n    ctx,\n    id,\n    feature.defaultValue === undefined ? null : feature.defaultValue,\n    \"defaultValue\",\n  );\n}\n\nexport function runExperiment<T>(\n  experiment: Experiment<T>,\n  featureId: string | null,\n  ctx: EvalContext,\n): {\n  result: Result<T>;\n  trackingCall?: Promise<void>;\n} {\n  const key = experiment.key;\n  const numVariations = experiment.variations.length;\n\n  // 1. If experiment has less than 2 variations, return immediately\n  if (numVariations < 2) {\n    process.env.NODE_ENV !== \"production\" &&\n      ctx.global.log(\"Invalid experiment\", { id: key });\n    return {\n      result: getExperimentResult(ctx, experiment, -1, false, featureId),\n    };\n  }\n\n  // 2. If the context is disabled, return immediately\n  if (ctx.global.enabled === false || ctx.user.enabled === false) {\n    process.env.NODE_ENV !== \"production\" &&\n      ctx.global.log(\"Context disabled\", { id: key });\n    return {\n      result: getExperimentResult(ctx, experiment, -1, false, featureId),\n    };\n  }\n\n  // 2.5. Merge in experiment overrides from the context\n  experiment = mergeOverrides(experiment, ctx);\n\n  // 2.6 New, more powerful URL targeting\n  if (\n    experiment.urlPatterns &&\n    !isURLTargeted(ctx.user.url || \"\", experiment.urlPatterns)\n  ) {\n    process.env.NODE_ENV !== \"production\" &&\n      ctx.global.log(\"Skip because of url targeting\", {\n        id: key,\n      });\n    return {\n      result: getExperimentResult(ctx, experiment, -1, false, featureId),\n    };\n  }\n\n  // 3. If a variation is forced from a querystring, return the forced variation\n  const qsOverride = getQueryStringOverride(\n    key,\n    ctx.user.url || \"\",\n    numVariations,\n  );\n  if (qsOverride !== null) {\n    process.env.NODE_ENV !== \"production\" &&\n      ctx.global.log(\"Force via querystring\", {\n        id: key,\n        variation: qsOverride,\n      });\n    return {\n      result: getExperimentResult(\n        ctx,\n        experiment,\n        qsOverride,\n        false,\n        featureId,\n      ),\n    };\n  }\n\n  // 4. If a variation is forced in the context, return the forced variation\n  const forcedVariations = getForcedVariations(ctx);\n  if (key in forcedVariations) {\n    const variation = forcedVariations[key];\n    process.env.NODE_ENV !== \"production\" &&\n      ctx.global.log(\"Force via dev tools\", {\n        id: key,\n        variation,\n      });\n    return {\n      result: getExperimentResult(ctx, experiment, variation, false, featureId),\n    };\n  }\n\n  // 5. Exclude if a draft experiment or not active\n  if (experiment.status === \"draft\" || experiment.active === false) {\n    process.env.NODE_ENV !== \"production\" &&\n      ctx.global.log(\"Skip because inactive\", {\n        id: key,\n      });\n    return {\n      result: getExperimentResult(ctx, experiment, -1, false, featureId),\n    };\n  }\n\n  // 6. Get the hash attribute and return if empty\n  const { hashAttribute, hashValue } = getHashAttribute(\n    ctx,\n    experiment.hashAttribute,\n    ctx.user.saveStickyBucketAssignmentDoc && !experiment.disableStickyBucketing\n      ? experiment.fallbackAttribute\n      : undefined,\n  );\n  if (!hashValue) {\n    process.env.NODE_ENV !== \"production\" &&\n      ctx.global.log(\"Skip because missing hashAttribute\", {\n        id: key,\n      });\n    return {\n      result: getExperimentResult(ctx, experiment, -1, false, featureId),\n    };\n  }\n\n  let assigned = -1;\n\n  let foundStickyBucket = false;\n  let stickyBucketVersionIsBlocked = false;\n  if (\n    ctx.user.saveStickyBucketAssignmentDoc &&\n    !experiment.disableStickyBucketing\n  ) {\n    const { variation, versionIsBlocked } = getStickyBucketVariation({\n      ctx,\n      expKey: experiment.key,\n      expBucketVersion: experiment.bucketVersion,\n      expHashAttribute: experiment.hashAttribute,\n      expFallbackAttribute: experiment.fallbackAttribute,\n      expMinBucketVersion: experiment.minBucketVersion,\n      expMeta: experiment.meta,\n    });\n    foundStickyBucket = variation >= 0;\n    assigned = variation;\n    stickyBucketVersionIsBlocked = !!versionIsBlocked;\n  }\n\n  // Some checks are not needed if we already have a sticky bucket\n  if (!foundStickyBucket) {\n    // 7. Exclude if user is filtered out (used to be called \"namespace\")\n    if (experiment.filters) {\n      if (isFilteredOut(experiment.filters, ctx)) {\n        process.env.NODE_ENV !== \"production\" &&\n          ctx.global.log(\"Skip because of filters\", {\n            id: key,\n          });\n        return {\n          result: getExperimentResult(ctx, experiment, -1, false, featureId),\n        };\n      }\n    } else if (\n      experiment.namespace &&\n      !inNamespace(hashValue, experiment.namespace)\n    ) {\n      process.env.NODE_ENV !== \"production\" &&\n        ctx.global.log(\"Skip because of namespace\", {\n          id: key,\n        });\n      return {\n        result: getExperimentResult(ctx, experiment, -1, false, featureId),\n      };\n    }\n\n    // 7.5. Exclude if experiment.include returns false or throws\n    if (experiment.include && !isIncluded(experiment.include)) {\n      process.env.NODE_ENV !== \"production\" &&\n        ctx.global.log(\"Skip because of include function\", {\n          id: key,\n        });\n      return {\n        result: getExperimentResult(ctx, experiment, -1, false, featureId),\n      };\n    }\n\n    // 8. Exclude if condition is false\n    if (experiment.condition && !conditionPasses(experiment.condition, ctx)) {\n      process.env.NODE_ENV !== \"production\" &&\n        ctx.global.log(\"Skip because of condition exp\", {\n          id: key,\n        });\n      return {\n        result: getExperimentResult(ctx, experiment, -1, false, featureId),\n      };\n    }\n\n    // 8.05. Exclude if prerequisites are not met\n    if (experiment.parentConditions) {\n      const evaluatedFeatures = new Set(ctx.stack.evaluatedFeatures);\n      for (const parentCondition of experiment.parentConditions) {\n        ctx.stack.evaluatedFeatures = new Set(evaluatedFeatures);\n        const parentResult = evalFeature(parentCondition.id, ctx);\n        // break out for cyclic prerequisites\n        if (parentResult.source === \"cyclicPrerequisite\") {\n          return {\n            result: getExperimentResult(ctx, experiment, -1, false, featureId),\n          };\n        }\n\n        const evalObj = { value: parentResult.value };\n        if (!evalCondition(evalObj, parentCondition.condition || {})) {\n          process.env.NODE_ENV !== \"production\" &&\n            ctx.global.log(\"Skip because prerequisite evaluation fails\", {\n              id: key,\n            });\n          return {\n            result: getExperimentResult(ctx, experiment, -1, false, featureId),\n          };\n        }\n      }\n    }\n\n    // 8.1. Exclude if user is not in a required group\n    if (\n      experiment.groups &&\n      !hasGroupOverlap(experiment.groups as string[], ctx)\n    ) {\n      process.env.NODE_ENV !== \"production\" &&\n        ctx.global.log(\"Skip because of groups\", {\n          id: key,\n        });\n      return {\n        result: getExperimentResult(ctx, experiment, -1, false, featureId),\n      };\n    }\n  }\n\n  // 8.2. Old style URL targeting\n  if (experiment.url && !urlIsValid(experiment.url as RegExp, ctx)) {\n    process.env.NODE_ENV !== \"production\" &&\n      ctx.global.log(\"Skip because of url\", {\n        id: key,\n      });\n    return {\n      result: getExperimentResult(ctx, experiment, -1, false, featureId),\n    };\n  }\n\n  // 9. Get the variation from the sticky bucket or get bucket ranges and choose variation\n  const n = hash(\n    experiment.seed || key,\n    hashValue,\n    experiment.hashVersion || 1,\n  );\n  if (n === null) {\n    process.env.NODE_ENV !== \"production\" &&\n      ctx.global.log(\"Skip because of invalid hash version\", {\n        id: key,\n      });\n    return {\n      result: getExperimentResult(ctx, experiment, -1, false, featureId),\n    };\n  }\n\n  if (!foundStickyBucket) {\n    const ranges =\n      experiment.ranges ||\n      getBucketRanges(\n        numVariations,\n        experiment.coverage === undefined ? 1 : experiment.coverage,\n        experiment.weights,\n      );\n    assigned = chooseVariation(n, ranges);\n  }\n\n  // 9.5 Unenroll if any prior sticky buckets are blocked by version\n  if (stickyBucketVersionIsBlocked) {\n    process.env.NODE_ENV !== \"production\" &&\n      ctx.global.log(\"Skip because sticky bucket version is blocked\", {\n        id: key,\n      });\n    return {\n      result: getExperimentResult(\n        ctx,\n        experiment,\n        -1,\n        false,\n        featureId,\n        undefined,\n        true,\n      ),\n    };\n  }\n\n  // 10. Return if not in experiment\n  if (assigned < 0) {\n    process.env.NODE_ENV !== \"production\" &&\n      ctx.global.log(\"Skip because of coverage\", {\n        id: key,\n      });\n    return {\n      result: getExperimentResult(ctx, experiment, -1, false, featureId),\n    };\n  }\n\n  // 11. Experiment has a forced variation\n  if (\"force\" in experiment) {\n    process.env.NODE_ENV !== \"production\" &&\n      ctx.global.log(\"Force variation\", {\n        id: key,\n        variation: experiment.force,\n      });\n    return {\n      result: getExperimentResult(\n        ctx,\n        experiment,\n        experiment.force === undefined ? -1 : experiment.force,\n        false,\n        featureId,\n      ),\n    };\n  }\n\n  // 12. Exclude if in QA mode\n  if (ctx.global.qaMode || ctx.user.qaMode) {\n    process.env.NODE_ENV !== \"production\" &&\n      ctx.global.log(\"Skip because QA mode\", {\n        id: key,\n      });\n    return {\n      result: getExperimentResult(ctx, experiment, -1, false, featureId),\n    };\n  }\n\n  // 12.5. Exclude if experiment is stopped\n  if (experiment.status === \"stopped\") {\n    process.env.NODE_ENV !== \"production\" &&\n      ctx.global.log(\"Skip because stopped\", {\n        id: key,\n      });\n    return {\n      result: getExperimentResult(ctx, experiment, -1, false, featureId),\n    };\n  }\n\n  // 13. Build the result object\n  const result = getExperimentResult(\n    ctx,\n    experiment,\n    assigned,\n    true,\n    featureId,\n    n,\n    foundStickyBucket,\n  );\n\n  // 13.5. Persist sticky bucket\n  if (\n    ctx.user.saveStickyBucketAssignmentDoc &&\n    !experiment.disableStickyBucketing\n  ) {\n    const {\n      changed,\n      key: attrKey,\n      doc,\n    } = generateStickyBucketAssignmentDoc(\n      ctx,\n      hashAttribute,\n      toString(hashValue),\n      {\n        [getStickyBucketExperimentKey(\n          experiment.key,\n          experiment.bucketVersion,\n        )]: result.key,\n      },\n    );\n    if (changed) {\n      // update local docs\n      ctx.user.stickyBucketAssignmentDocs =\n        ctx.user.stickyBucketAssignmentDocs || {};\n      ctx.user.stickyBucketAssignmentDocs[attrKey] = doc;\n      // save doc\n      ctx.user.saveStickyBucketAssignmentDoc(doc);\n    }\n  }\n\n  // 14. Fire the tracking callback(s)\n  // Store the promise in case we're awaiting it (ex: browser url redirects)\n  const trackingCalls = onExperimentViewed(ctx, experiment, result);\n  if (trackingCalls.length === 0 && ctx.global.saveDeferredTrack) {\n    ctx.global.saveDeferredTrack({\n      experiment,\n      result,\n    });\n  }\n  const trackingCall = !trackingCalls.length\n    ? undefined\n    : trackingCalls.length === 1\n      ? trackingCalls[0]\n      : Promise.all(trackingCalls).then(() => {});\n\n  // 14.1 Keep track of completed changeIds\n  \"changeId\" in experiment &&\n    experiment.changeId &&\n    ctx.global.recordChangeId &&\n    ctx.global.recordChangeId(experiment.changeId as string);\n\n  // 15. Return the result\n  process.env.NODE_ENV !== \"production\" &&\n    ctx.global.log(\"In experiment\", {\n      id: key,\n      variation: result.variationId,\n    });\n  return { result, trackingCall };\n}\n\nfunction getFeatureResult<T>(\n  ctx: EvalContext,\n  key: string,\n  value: T,\n  source: FeatureResultSource,\n  ruleId?: string,\n  experiment?: Experiment<T>,\n  result?: Result<T>,\n): FeatureResult<T> {\n  const ret: FeatureResult = {\n    value,\n    on: !!value,\n    off: !value,\n    source,\n    ruleId: ruleId || \"\",\n  };\n  if (experiment) ret.experiment = experiment;\n  if (result) ret.experimentResult = result;\n\n  // Track the usage of this feature in real-time\n  if (source !== \"override\") {\n    onFeatureUsage(ctx, key, ret);\n  }\n\n  return ret;\n}\n\nfunction getAttributes(ctx: EvalContext) {\n  return {\n    ...ctx.user.attributes,\n    ...ctx.user.attributeOverrides,\n  };\n}\n\nfunction conditionPasses(\n  condition: ConditionInterface,\n  ctx: EvalContext,\n): boolean {\n  return evalCondition(\n    getAttributes(ctx),\n    condition,\n    ctx.global.savedGroups || {},\n  );\n}\n\nfunction isFilteredOut(filters: Filter[], ctx: EvalContext): boolean {\n  return filters.some((filter) => {\n    const { hashValue } = getHashAttribute(ctx, filter.attribute);\n    if (!hashValue) return true;\n    const n = hash(filter.seed, hashValue, filter.hashVersion || 2);\n    if (n === null) return true;\n    return !filter.ranges.some((r) => inRange(n, r));\n  });\n}\n\nfunction isIncludedInRollout(\n  ctx: EvalContext,\n  seed: string,\n  hashAttribute: string | undefined,\n  fallbackAttribute: string | undefined,\n  range: VariationRange | undefined,\n  coverage: number | undefined,\n  hashVersion: number | undefined,\n): boolean {\n  if (!range && coverage === undefined) return true;\n\n  if (!range && coverage === 0) return false;\n\n  const { hashValue } = getHashAttribute(ctx, hashAttribute, fallbackAttribute);\n  if (!hashValue) {\n    return false;\n  }\n\n  const n = hash(seed, hashValue, hashVersion || 1);\n  if (n === null) return false;\n\n  return range\n    ? inRange(n, range)\n    : coverage !== undefined\n      ? n <= coverage\n      : true;\n}\n\nexport function getExperimentResult<T>(\n  ctx: EvalContext,\n  experiment: Experiment<T>,\n  variationIndex: number,\n  hashUsed: boolean,\n  featureId: string | null,\n  bucket?: number,\n  stickyBucketUsed?: boolean,\n): Result<T> {\n  let inExperiment = true;\n  // If assigned variation is not valid, use the baseline and mark the user as not in the experiment\n  if (variationIndex < 0 || variationIndex >= experiment.variations.length) {\n    variationIndex = 0;\n    inExperiment = false;\n  }\n\n  const { hashAttribute, hashValue } = getHashAttribute(\n    ctx,\n    experiment.hashAttribute,\n    ctx.user.saveStickyBucketAssignmentDoc && !experiment.disableStickyBucketing\n      ? experiment.fallbackAttribute\n      : undefined,\n  );\n\n  const meta: Partial<VariationMeta> = experiment.meta\n    ? experiment.meta[variationIndex]\n    : {};\n\n  const res: Result<T> = {\n    key: meta.key || \"\" + variationIndex,\n    featureId,\n    inExperiment,\n    hashUsed,\n    variationId: variationIndex,\n    value: experiment.variations[variationIndex],\n    hashAttribute,\n    hashValue,\n    stickyBucketUsed: !!stickyBucketUsed,\n  };\n\n  if (meta.name) res.name = meta.name;\n  if (bucket !== undefined) res.bucket = bucket;\n  if (meta.passthrough) res.passthrough = meta.passthrough;\n\n  return res;\n}\n\nfunction mergeOverrides<T>(\n  experiment: Experiment<T>,\n  ctx: EvalContext,\n): Experiment<T> {\n  const key = experiment.key;\n  const o = ctx.global.overrides;\n  if (o && o[key]) {\n    experiment = Object.assign({}, experiment, o[key]);\n    if (typeof experiment.url === \"string\") {\n      experiment.url = getUrlRegExp(\n        // eslint-disable-next-line\n        experiment.url as any,\n      );\n    }\n  }\n\n  return experiment;\n}\n\nexport function getHashAttribute(\n  ctx: EvalContext,\n  attr?: string,\n  fallback?: string,\n) {\n  let hashAttribute = attr || \"id\";\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  let hashValue: any = \"\";\n\n  const attributes = getAttributes(ctx);\n\n  if (attributes[hashAttribute]) {\n    hashValue = attributes[hashAttribute];\n  }\n\n  // if no match, try fallback\n  if (!hashValue && fallback) {\n    if (attributes[fallback]) {\n      hashValue = attributes[fallback];\n    }\n    if (hashValue) {\n      hashAttribute = fallback;\n    }\n  }\n\n  return { hashAttribute, hashValue };\n}\n\nfunction urlIsValid(urlRegex: RegExp, ctx: EvalContext): boolean {\n  const url = ctx.user.url;\n  if (!url) return false;\n\n  const pathOnly = url.replace(/^https?:\\/\\//, \"\").replace(/^[^/]*\\//, \"/\");\n\n  if (urlRegex.test(url)) return true;\n  if (urlRegex.test(pathOnly)) return true;\n  return false;\n}\n\nfunction hasGroupOverlap(expGroups: string[], ctx: EvalContext): boolean {\n  const groups = ctx.global.groups || {};\n  for (let i = 0; i < expGroups.length; i++) {\n    if (groups[expGroups[i]]) return true;\n  }\n  return false;\n}\n\nfunction getStickyBucketVariation({\n  ctx,\n  expKey,\n  expBucketVersion,\n  expHashAttribute,\n  expFallbackAttribute,\n  expMinBucketVersion,\n  expMeta,\n}: {\n  ctx: EvalContext;\n  expKey: string;\n  expBucketVersion?: number;\n  expHashAttribute?: string;\n  expFallbackAttribute?: string;\n  expMinBucketVersion?: number;\n  expMeta?: VariationMeta[];\n}): {\n  variation: number;\n  versionIsBlocked?: boolean;\n} {\n  expBucketVersion = expBucketVersion || 0;\n  expMinBucketVersion = expMinBucketVersion || 0;\n  expHashAttribute = expHashAttribute || \"id\";\n  expMeta = expMeta || [];\n  const id = getStickyBucketExperimentKey(expKey, expBucketVersion);\n  const assignments = getStickyBucketAssignments(\n    ctx,\n    expHashAttribute,\n    expFallbackAttribute,\n  );\n\n  // users with any blocked bucket version (0 to minExperimentBucketVersion - 1) are excluded from the test\n  if (expMinBucketVersion > 0) {\n    for (let i = 0; i < expMinBucketVersion; i++) {\n      const blockedKey = getStickyBucketExperimentKey(expKey, i);\n      if (assignments[blockedKey] !== undefined) {\n        return {\n          variation: -1,\n          versionIsBlocked: true,\n        };\n      }\n    }\n  }\n  const variationKey = assignments[id];\n  if (variationKey === undefined)\n    // no assignment found\n    return { variation: -1 };\n  const variation = expMeta.findIndex((m) => m.key === variationKey);\n  if (variation < 0)\n    // invalid assignment, treat as \"no assignment found\"\n    return { variation: -1 };\n\n  return { variation };\n}\n\nfunction getStickyBucketExperimentKey(\n  experimentKey: string,\n  experimentBucketVersion?: number,\n): StickyExperimentKey {\n  experimentBucketVersion = experimentBucketVersion || 0;\n  return `${experimentKey}__${experimentBucketVersion}`;\n}\n\nexport function getStickyBucketAttributeKey(\n  attributeName: string,\n  attributeValue: string,\n): StickyAttributeKey {\n  return `${attributeName}||${attributeValue}`;\n}\n\nfunction getStickyBucketAssignments(\n  ctx: EvalContext,\n  expHashAttribute: string,\n  expFallbackAttribute?: string,\n): StickyAssignments {\n  if (!ctx.user.stickyBucketAssignmentDocs) return {};\n  const { hashAttribute, hashValue } = getHashAttribute(ctx, expHashAttribute);\n  const hashKey = getStickyBucketAttributeKey(\n    hashAttribute,\n    toString(hashValue),\n  );\n\n  const { hashAttribute: fallbackAttribute, hashValue: fallbackValue } =\n    getHashAttribute(ctx, expFallbackAttribute);\n  const fallbackKey = fallbackValue\n    ? getStickyBucketAttributeKey(fallbackAttribute, toString(fallbackValue))\n    : null;\n\n  const assignments: StickyAssignments = {};\n  if (fallbackKey && ctx.user.stickyBucketAssignmentDocs[fallbackKey]) {\n    Object.assign(\n      assignments,\n      ctx.user.stickyBucketAssignmentDocs[fallbackKey].assignments || {},\n    );\n  }\n  if (ctx.user.stickyBucketAssignmentDocs[hashKey]) {\n    Object.assign(\n      assignments,\n      ctx.user.stickyBucketAssignmentDocs[hashKey].assignments || {},\n    );\n  }\n  return assignments;\n}\n\nfunction generateStickyBucketAssignmentDoc(\n  ctx: EvalContext,\n  attributeName: string,\n  attributeValue: string,\n  assignments: StickyAssignments,\n): {\n  key: StickyAttributeKey;\n  doc: StickyAssignmentsDocument;\n  changed: boolean;\n} {\n  const key = getStickyBucketAttributeKey(attributeName, attributeValue);\n  const existingAssignments =\n    ctx.user.stickyBucketAssignmentDocs &&\n    ctx.user.stickyBucketAssignmentDocs[key]\n      ? ctx.user.stickyBucketAssignmentDocs[key].assignments || {}\n      : {};\n  const newAssignments = { ...existingAssignments, ...assignments };\n  const changed =\n    JSON.stringify(existingAssignments) !== JSON.stringify(newAssignments);\n\n  return {\n    key,\n    doc: {\n      attributeName,\n      attributeValue,\n      assignments: newAssignments,\n    },\n    changed,\n  };\n}\n\nfunction deriveStickyBucketIdentifierAttributes(\n  ctx: EvalContext,\n  data?: FeatureApiResponse,\n) {\n  const attributes = new Set<string>();\n  const features =\n    data && data.features ? data.features : ctx.global.features || {};\n  const experiments =\n    data && data.experiments ? data.experiments : ctx.global.experiments || [];\n  Object.keys(features).forEach((id) => {\n    const feature = features[id];\n    if (feature.rules) {\n      for (const rule of feature.rules) {\n        if (rule.variations) {\n          attributes.add(rule.hashAttribute || \"id\");\n          if (rule.fallbackAttribute) {\n            attributes.add(rule.fallbackAttribute);\n          }\n        }\n      }\n    }\n  });\n  experiments.map((experiment) => {\n    attributes.add(experiment.hashAttribute || \"id\");\n    if (experiment.fallbackAttribute) {\n      attributes.add(experiment.fallbackAttribute);\n    }\n  });\n  return Array.from(attributes);\n}\n\nexport async function getAllStickyBucketAssignmentDocs(\n  ctx: EvalContext,\n  stickyBucketService: StickyBucketService,\n  data?: FeatureApiResponse,\n) {\n  const attributes = getStickyBucketAttributes(ctx, data);\n  return stickyBucketService.getAllAssignments(attributes);\n}\n\nexport function getStickyBucketAttributes(\n  ctx: EvalContext,\n  data?: FeatureApiResponse,\n): Record<string, string> {\n  const attributes: Record<string, string> = {};\n  const stickyBucketIdentifierAttributes =\n    deriveStickyBucketIdentifierAttributes(ctx, data);\n  stickyBucketIdentifierAttributes.forEach((attr) => {\n    const { hashValue } = getHashAttribute(ctx, attr);\n    attributes[attr] = toString(hashValue);\n  });\n  return attributes;\n}\n\nexport async function decryptPayload(\n  data: FeatureApiResponse,\n  decryptionKey: string | undefined,\n  subtle?: SubtleCrypto,\n): Promise<FeatureApiResponse> {\n  data = { ...data };\n  if (data.encryptedFeatures) {\n    try {\n      data.features = JSON.parse(\n        await decrypt(data.encryptedFeatures, decryptionKey, subtle),\n      );\n    } catch (e) {\n      console.error(e);\n    }\n    delete data.encryptedFeatures;\n  }\n  if (data.encryptedExperiments) {\n    try {\n      data.experiments = JSON.parse(\n        await decrypt(data.encryptedExperiments, decryptionKey, subtle),\n      );\n    } catch (e) {\n      console.error(e);\n    }\n    delete data.encryptedExperiments;\n  }\n  if (data.encryptedSavedGroups) {\n    try {\n      data.savedGroups = JSON.parse(\n        await decrypt(data.encryptedSavedGroups, decryptionKey, subtle),\n      );\n    } catch (e) {\n      console.error(e);\n    }\n    delete data.encryptedSavedGroups;\n  }\n  return data;\n}\n\nexport function getApiHosts(options: Options | ClientOptions): {\n  apiHost: string;\n  streamingHost: string;\n  apiRequestHeaders?: Record<string, string>;\n  streamingHostRequestHeaders?: Record<string, string>;\n} {\n  const defaultHost = options.apiHost || \"https://cdn.growthbook.io\";\n  return {\n    apiHost: defaultHost.replace(/\\/*$/, \"\"),\n    streamingHost: (options.streamingHost || defaultHost).replace(/\\/*$/, \"\"),\n    apiRequestHeaders: options.apiHostRequestHeaders,\n    streamingHostRequestHeaders: options.streamingHostRequestHeaders,\n  };\n}\n\nexport function getExperimentDedupeKey(\n  experiment: Experiment<unknown>,\n  result: Result<unknown>,\n) {\n  return (\n    result.hashAttribute +\n    result.hashValue +\n    experiment.key +\n    result.variationId\n  );\n}\n","import mutate, { DeclarativeMutation } from \"dom-mutator\";\nimport type {\n  ApiHost,\n  Attributes,\n  AutoExperiment,\n  AutoExperimentVariation,\n  ClientKey,\n  Options,\n  Experiment,\n  FeatureApiResponse,\n  FeatureDefinition,\n  FeatureResult,\n  FeatureUsageCallback,\n  LoadFeaturesOptions,\n  RefreshFeaturesOptions,\n  RenderFunction,\n  Result,\n  SubscriptionFunction,\n  TrackingCallback,\n  TrackingData,\n  WidenPrimitives,\n  EvalContext,\n  InitOptions,\n  InitResponse,\n  InitSyncOptions,\n  PrefetchOptions,\n  GlobalContext,\n  UserContext,\n  StickyAssignmentsDocument,\n  EventLogger,\n  LogUnion,\n  DestroyOptions,\n} from \"./types/growthbook\";\nimport {\n  decrypt,\n  getAutoExperimentChangeType,\n  isURLTargeted,\n  loadSDKVersion,\n  mergeQueryStrings,\n  promiseTimeout,\n} from \"./util\";\nimport {\n  clearAutoRefresh,\n  configureCache,\n  refreshFeatures,\n  startStreaming,\n  unsubscribe,\n} from \"./feature-repository\";\nimport {\n  runExperiment,\n  evalFeature as _evalFeature,\n  getExperimentResult,\n  getAllStickyBucketAssignmentDocs,\n  decryptPayload,\n  getApiHosts,\n  getExperimentDedupeKey,\n  getStickyBucketAttributes,\n} from \"./core\";\nimport { StickyBucketServiceSync } from \"./sticky-bucket-service\";\n\nconst isBrowser =\n  typeof window !== \"undefined\" && typeof document !== \"undefined\";\n\nconst SDK_VERSION = loadSDKVersion();\n\nexport class GrowthBook<\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  AppFeatures extends Record<string, any> = Record<string, any>,\n> {\n  // context is technically private, but some tools depend on it so we can't mangle the name\n  private context: Options;\n  public debug: boolean;\n  public ready: boolean;\n  public version: string;\n  public logs: Array<LogUnion>;\n\n  // Properties and methods that start with \"_\" are mangled by Terser (saves ~150 bytes)\n  private _options: Options;\n  private _renderer: null | RenderFunction;\n  private _redirectedUrl: string;\n  private _trackedExperiments: Set<string>;\n  private _completedChangeIds: Set<string>;\n  private _trackedFeatures: Record<string, string>;\n  private _subscriptions: Set<SubscriptionFunction>;\n  private _assigned: Map<\n    string,\n    {\n      // eslint-disable-next-line\n      experiment: Experiment<any>;\n      // eslint-disable-next-line\n      result: Result<any>;\n    }\n  >;\n  private _activeAutoExperiments: Map<\n    AutoExperiment,\n    { valueHash: string; undo: () => void }\n  >;\n  private _triggeredExpKeys: Set<string>;\n  private _initialized: boolean;\n  private _deferredTrackingCalls: Map<string, TrackingData>;\n  private _saveStickyBucketAssignmentDoc:\n    | undefined\n    | ((doc: StickyAssignmentsDocument) => Promise<unknown>);\n\n  private _payload: FeatureApiResponse | undefined;\n  private _decryptedPayload: FeatureApiResponse | undefined;\n  private _destroyCallbacks: (() => void)[];\n\n  private _autoExperimentsAllowed: boolean;\n  private _destroyed?: boolean;\n\n  constructor(options?: Options) {\n    options = options || {};\n    // These properties are all initialized in the constructor instead of above\n    // This saves ~80 bytes in the final output\n    this.version = SDK_VERSION;\n    this._options = this.context = options;\n    this._renderer = options.renderer || null;\n    this._trackedExperiments = new Set();\n    this._completedChangeIds = new Set();\n    this._trackedFeatures = {};\n    this.debug = !!options.debug;\n    this._subscriptions = new Set();\n    this.ready = false;\n    this._assigned = new Map();\n    this._activeAutoExperiments = new Map();\n    this._triggeredExpKeys = new Set();\n    this._initialized = false;\n    this._redirectedUrl = \"\";\n    this._deferredTrackingCalls = new Map();\n    this._autoExperimentsAllowed = !options.disableExperimentsOnLoad;\n    this._destroyCallbacks = [];\n    this.logs = [];\n\n    this.log = this.log.bind(this);\n    this._saveDeferredTrack = this._saveDeferredTrack.bind(this);\n    this._onExperimentEval = this._onExperimentEval.bind(this);\n    this._fireSubscriptions = this._fireSubscriptions.bind(this);\n    this._recordChangedId = this._recordChangedId.bind(this);\n\n    if (options.remoteEval) {\n      if (options.decryptionKey) {\n        throw new Error(\"Encryption is not available for remoteEval\");\n      }\n      if (!options.clientKey) {\n        throw new Error(\"Missing clientKey\");\n      }\n      let isGbHost = false;\n      try {\n        isGbHost = !!new URL(options.apiHost || \"\").hostname.match(\n          /growthbook\\.io$/i,\n        );\n      } catch (e) {\n        // ignore invalid URLs\n      }\n      if (isGbHost) {\n        throw new Error(\"Cannot use remoteEval on GrowthBook Cloud\");\n      }\n    } else {\n      if (options.cacheKeyAttributes) {\n        throw new Error(\"cacheKeyAttributes are only used for remoteEval\");\n      }\n    }\n\n    if (options.stickyBucketService) {\n      const s = options.stickyBucketService;\n      this._saveStickyBucketAssignmentDoc = (doc) => {\n        return s.saveAssignments(doc);\n      };\n    }\n\n    if (options.plugins) {\n      for (const plugin of options.plugins) {\n        plugin(this);\n      }\n    }\n\n    if (options.features) {\n      this.ready = true;\n    }\n\n    if (isBrowser && options.enableDevMode) {\n      window._growthbook = this;\n      document.dispatchEvent(new Event(\"gbloaded\"));\n    }\n\n    if (options.experiments) {\n      this.ready = true;\n      this._updateAllAutoExperiments();\n    }\n\n    // Hydrate sticky bucket service\n    if (\n      this._options.stickyBucketService &&\n      this._options.stickyBucketAssignmentDocs\n    ) {\n      for (const key in this._options.stickyBucketAssignmentDocs) {\n        const doc = this._options.stickyBucketAssignmentDocs[key];\n        if (doc) {\n          this._options.stickyBucketService.saveAssignments(doc).catch(() => {\n            // Ignore hydration errors\n          });\n        }\n      }\n    }\n\n    // Legacy - passing in features/experiments into the constructor instead of using init\n    if (this.ready) {\n      this.refreshStickyBuckets(this.getPayload());\n    }\n  }\n\n  public async setPayload(payload: FeatureApiResponse): Promise<void> {\n    this._payload = payload;\n    const data = await decryptPayload(payload, this._options.decryptionKey);\n    this._decryptedPayload = data;\n    await this.refreshStickyBuckets(data);\n    if (data.features) {\n      this._options.features = data.features;\n    }\n    if (data.savedGroups) {\n      this._options.savedGroups = data.savedGroups;\n    }\n    if (data.experiments) {\n      this._options.experiments = data.experiments;\n      this._updateAllAutoExperiments();\n    }\n    this.ready = true;\n    this._render();\n  }\n\n  public initSync(options: InitSyncOptions): GrowthBook {\n    this._initialized = true;\n\n    const payload = options.payload;\n\n    if (payload.encryptedExperiments || payload.encryptedFeatures) {\n      throw new Error(\"initSync does not support encrypted payloads\");\n    }\n\n    if (\n      this._options.stickyBucketService &&\n      !this._options.stickyBucketAssignmentDocs\n    ) {\n      this._options.stickyBucketAssignmentDocs =\n        this.generateStickyBucketAssignmentDocsSync(\n          this._options.stickyBucketService as StickyBucketServiceSync,\n          payload,\n        );\n    }\n\n    this._payload = payload;\n    this._decryptedPayload = payload;\n    if (payload.features) {\n      this._options.features = payload.features;\n    }\n    if (payload.experiments) {\n      this._options.experiments = payload.experiments;\n      this._updateAllAutoExperiments();\n    }\n\n    this.ready = true;\n\n    startStreaming(this, options);\n\n    return this;\n  }\n\n  public async init(options?: InitOptions): Promise<InitResponse> {\n    this._initialized = true;\n    options = options || {};\n\n    if (options.cacheSettings) {\n      configureCache(options.cacheSettings);\n    }\n\n    if (options.payload) {\n      await this.setPayload(options.payload);\n      startStreaming(this, options);\n      return {\n        success: true,\n        source: \"init\",\n      };\n    } else {\n      const { data, ...res } = await this._refresh({\n        ...options,\n        allowStale: true,\n      });\n      startStreaming(this, options);\n      await this.setPayload(data || {});\n      return res;\n    }\n  }\n\n  /** @deprecated Use {@link init} */\n  public async loadFeatures(options?: LoadFeaturesOptions): Promise<void> {\n    options = options || {};\n    await this.init({\n      skipCache: options.skipCache,\n      timeout: options.timeout,\n      streaming:\n        (this._options.backgroundSync ?? true) &&\n        (options.autoRefresh || this._options.subscribeToChanges),\n    });\n  }\n\n  public async refreshFeatures(\n    options?: RefreshFeaturesOptions,\n  ): Promise<void> {\n    const res = await this._refresh({\n      ...(options || {}),\n      allowStale: false,\n    });\n    if (res.data) {\n      await this.setPayload(res.data);\n    }\n  }\n\n  public getApiInfo(): [ApiHost, ClientKey] {\n    return [this.getApiHosts().apiHost, this.getClientKey()];\n  }\n  public getApiHosts() {\n    return getApiHosts(this._options);\n  }\n  public getClientKey(): string {\n    return this._options.clientKey || \"\";\n  }\n  public getPayload(): FeatureApiResponse {\n    return (\n      this._payload || {\n        features: this.getFeatures(),\n        experiments: this.getExperiments(),\n      }\n    );\n  }\n  public getDecryptedPayload(): FeatureApiResponse {\n    return this._decryptedPayload || this.getPayload();\n  }\n\n  public isRemoteEval(): boolean {\n    return this._options.remoteEval || false;\n  }\n\n  public getCacheKeyAttributes(): (keyof Attributes)[] | undefined {\n    return this._options.cacheKeyAttributes;\n  }\n\n  private async _refresh({\n    timeout,\n    skipCache,\n    allowStale,\n    streaming,\n  }: RefreshFeaturesOptions & {\n    allowStale?: boolean;\n    streaming?: boolean;\n  }) {\n    if (!this._options.clientKey) {\n      throw new Error(\"Missing clientKey\");\n    }\n    // Trigger refresh in feature repository\n    return refreshFeatures({\n      instance: this,\n      timeout,\n      skipCache: skipCache || this._options.disableCache,\n      allowStale,\n      backgroundSync: streaming ?? this._options.backgroundSync ?? true,\n    });\n  }\n\n  private _render() {\n    if (this._renderer) {\n      try {\n        this._renderer();\n      } catch (e) {\n        console.error(\"Failed to render\", e);\n      }\n    }\n  }\n\n  /** @deprecated Use {@link setPayload} */\n  public setFeatures(features: Record<string, FeatureDefinition>) {\n    this._options.features = features;\n    this.ready = true;\n    this._render();\n  }\n\n  /** @deprecated Use {@link setPayload} */\n  public async setEncryptedFeatures(\n    encryptedString: string,\n    decryptionKey?: string,\n    subtle?: SubtleCrypto,\n  ): Promise<void> {\n    const featuresJSON = await decrypt(\n      encryptedString,\n      decryptionKey || this._options.decryptionKey,\n      subtle,\n    );\n    this.setFeatures(\n      JSON.parse(featuresJSON) as Record<string, FeatureDefinition>,\n    );\n  }\n\n  /** @deprecated Use {@link setPayload} */\n  public setExperiments(experiments: AutoExperiment[]): void {\n    this._options.experiments = experiments;\n    this.ready = true;\n    this._updateAllAutoExperiments();\n  }\n\n  /** @deprecated Use {@link setPayload} */\n  public async setEncryptedExperiments(\n    encryptedString: string,\n    decryptionKey?: string,\n    subtle?: SubtleCrypto,\n  ): Promise<void> {\n    const experimentsJSON = await decrypt(\n      encryptedString,\n      decryptionKey || this._options.decryptionKey,\n      subtle,\n    );\n    this.setExperiments(JSON.parse(experimentsJSON) as AutoExperiment[]);\n  }\n\n  public async setAttributes(attributes: Attributes) {\n    this._options.attributes = attributes;\n    if (this._options.stickyBucketService) {\n      await this.refreshStickyBuckets();\n    }\n    if (this._options.remoteEval) {\n      await this._refreshForRemoteEval();\n      return;\n    }\n    this._render();\n    this._updateAllAutoExperiments();\n  }\n\n  public async updateAttributes(attributes: Attributes) {\n    return this.setAttributes({ ...this._options.attributes, ...attributes });\n  }\n\n  public async setAttributeOverrides(overrides: Attributes) {\n    this._options.attributeOverrides = overrides;\n    if (this._options.stickyBucketService) {\n      await this.refreshStickyBuckets();\n    }\n    if (this._options.remoteEval) {\n      await this._refreshForRemoteEval();\n      return;\n    }\n    this._render();\n    this._updateAllAutoExperiments();\n  }\n\n  public async setForcedVariations(vars: Record<string, number>) {\n    this._options.forcedVariations = vars || {};\n    if (this._options.remoteEval) {\n      await this._refreshForRemoteEval();\n      return;\n    }\n    this._render();\n    this._updateAllAutoExperiments();\n  }\n\n  // eslint-disable-next-line\n  public setForcedFeatures(map: Map<string, any>) {\n    this._options.forcedFeatureValues = map;\n    this._render();\n  }\n\n  public async setURL(url: string) {\n    if (url === this._options.url) return;\n    this._options.url = url;\n    this._redirectedUrl = \"\";\n    if (this._options.remoteEval) {\n      await this._refreshForRemoteEval();\n      this._updateAllAutoExperiments(true);\n      return;\n    }\n    this._updateAllAutoExperiments(true);\n  }\n\n  public getAttributes() {\n    return { ...this._options.attributes, ...this._options.attributeOverrides };\n  }\n\n  public getForcedVariations() {\n    return this._options.forcedVariations || {};\n  }\n\n  public getForcedFeatures() {\n    // eslint-disable-next-line\n    return this._options.forcedFeatureValues || new Map<string, any>();\n  }\n\n  public getStickyBucketAssignmentDocs() {\n    return this._options.stickyBucketAssignmentDocs || {};\n  }\n\n  public getUrl() {\n    return this._options.url || \"\";\n  }\n\n  public getFeatures() {\n    return this._options.features || {};\n  }\n\n  public getExperiments() {\n    return this._options.experiments || [];\n  }\n\n  public getCompletedChangeIds(): string[] {\n    return Array.from(this._completedChangeIds);\n  }\n\n  public subscribe(cb: SubscriptionFunction): () => void {\n    this._subscriptions.add(cb);\n    return () => {\n      this._subscriptions.delete(cb);\n    };\n  }\n\n  private async _refreshForRemoteEval() {\n    if (!this._options.remoteEval) return;\n    if (!this._initialized) return;\n    const res = await this._refresh({\n      allowStale: false,\n    });\n    if (res.data) {\n      await this.setPayload(res.data);\n    }\n  }\n\n  public getAllResults() {\n    return new Map(this._assigned);\n  }\n\n  public onDestroy(cb: () => void) {\n    this._destroyCallbacks.push(cb);\n  }\n\n  public isDestroyed() {\n    return !!this._destroyed;\n  }\n\n  public destroy(options?: DestroyOptions) {\n    options = options || {};\n    this._destroyed = true;\n\n    // Custom callbacks\n    // Do this first in case it needs access to the below data that is cleared\n    this._destroyCallbacks.forEach((cb) => {\n      try {\n        cb();\n      } catch (e) {\n        console.error(e);\n      }\n    });\n\n    // Release references to save memory\n    this._subscriptions.clear();\n    this._assigned.clear();\n    this._trackedExperiments.clear();\n    this._completedChangeIds.clear();\n    this._deferredTrackingCalls.clear();\n    this._trackedFeatures = {};\n    this._destroyCallbacks = [];\n    this._payload = undefined;\n    this._saveStickyBucketAssignmentDoc = undefined;\n    unsubscribe(this);\n    if (options.destroyAllStreams) {\n      clearAutoRefresh();\n    }\n    this.logs = [];\n\n    if (isBrowser && window._growthbook === this) {\n      delete window._growthbook;\n    }\n\n    // Undo any active auto experiments\n    this._activeAutoExperiments.forEach((exp) => {\n      exp.undo();\n    });\n    this._activeAutoExperiments.clear();\n    this._triggeredExpKeys.clear();\n  }\n\n  public setRenderer(renderer: null | RenderFunction) {\n    this._renderer = renderer;\n  }\n\n  public forceVariation(key: string, variation: number) {\n    this._options.forcedVariations = this._options.forcedVariations || {};\n    this._options.forcedVariations[key] = variation;\n    if (this._options.remoteEval) {\n      this._refreshForRemoteEval();\n      return;\n    }\n    this._updateAllAutoExperiments();\n    this._render();\n  }\n\n  public run<T>(experiment: Experiment<T>): Result<T> {\n    const { result } = runExperiment(experiment, null, this._getEvalContext());\n    this._onExperimentEval(experiment, result);\n    return result;\n  }\n\n  public triggerExperiment(key: string) {\n    this._triggeredExpKeys.add(key);\n    if (!this._options.experiments) return null;\n    const experiments = this._options.experiments.filter(\n      (exp) => exp.key === key,\n    );\n    return experiments\n      .map((exp) => {\n        return this._runAutoExperiment(exp);\n      })\n      .filter((res) => res !== null);\n  }\n\n  public triggerAutoExperiments() {\n    this._autoExperimentsAllowed = true;\n    this._updateAllAutoExperiments(true);\n  }\n\n  private _getEvalContext(): EvalContext {\n    return {\n      user: this._getUserContext(),\n      global: this._getGlobalContext(),\n      stack: {\n        evaluatedFeatures: new Set(),\n      },\n    };\n  }\n\n  private _getUserContext(): UserContext {\n    return {\n      attributes: this._options.user\n        ? {\n            ...this._options.user,\n            ...this._options.attributes,\n          }\n        : this._options.attributes,\n      enableDevMode: this._options.enableDevMode,\n      blockedChangeIds: this._options.blockedChangeIds,\n      stickyBucketAssignmentDocs: this._options.stickyBucketAssignmentDocs,\n      url: this._getContextUrl(),\n      forcedVariations: this._options.forcedVariations,\n      forcedFeatureValues: this._options.forcedFeatureValues,\n      attributeOverrides: this._options.attributeOverrides,\n      saveStickyBucketAssignmentDoc: this._saveStickyBucketAssignmentDoc,\n      trackingCallback: this._options.trackingCallback,\n      onFeatureUsage: this._options.onFeatureUsage,\n      devLogs: this.logs,\n      trackedExperiments: this._trackedExperiments,\n      trackedFeatureUsage: this._trackedFeatures,\n    };\n  }\n  private _getGlobalContext(): GlobalContext {\n    return {\n      features: this._options.features,\n      experiments: this._options.experiments,\n      log: this.log,\n      enabled: this._options.enabled,\n      qaMode: this._options.qaMode,\n      savedGroups: this._options.savedGroups,\n      groups: this._options.groups,\n      overrides: this._options.overrides,\n      onExperimentEval: this._onExperimentEval,\n      recordChangeId: this._recordChangedId,\n      saveDeferredTrack: this._saveDeferredTrack,\n      eventLogger: this._options.eventLogger,\n    };\n  }\n\n  private _runAutoExperiment(experiment: AutoExperiment, forceRerun?: boolean) {\n    const existing = this._activeAutoExperiments.get(experiment);\n\n    // If this is a manual experiment and it's not already running, skip\n    if (\n      experiment.manual &&\n      !this._triggeredExpKeys.has(experiment.key) &&\n      !existing\n    )\n      return null;\n\n    // Check if this particular experiment is blocked by options settings\n    // For example, if all visualEditor experiments are disabled\n    const isBlocked = this._isAutoExperimentBlockedByContext(experiment);\n    if (isBlocked) {\n      process.env.NODE_ENV !== \"production\" &&\n        this.log(\"Auto experiment blocked\", { id: experiment.key });\n    }\n\n    let result: Result<AutoExperimentVariation> | undefined;\n    let trackingCall: Promise<void> | undefined;\n    // Run the experiment (if blocked exclude)\n    if (isBlocked) {\n      result = getExperimentResult(\n        this._getEvalContext(),\n        experiment,\n        -1,\n        false,\n        \"\",\n      );\n    } else {\n      ({ result, trackingCall } = runExperiment(\n        experiment,\n        null,\n        this._getEvalContext(),\n      ));\n      this._onExperimentEval(experiment, result);\n    }\n\n    // A hash to quickly tell if the assigned value changed\n    const valueHash = JSON.stringify(result.value);\n\n    // If the changes are already active, no need to re-apply them\n    if (\n      !forceRerun &&\n      result.inExperiment &&\n      existing &&\n      existing.valueHash === valueHash\n    ) {\n      return result;\n    }\n\n    // Undo any existing changes\n    if (existing) this._undoActiveAutoExperiment(experiment);\n\n    // Apply new changes\n    if (result.inExperiment) {\n      const changeType = getAutoExperimentChangeType(experiment);\n\n      if (\n        changeType === \"redirect\" &&\n        result.value.urlRedirect &&\n        experiment.urlPatterns\n      ) {\n        const url = experiment.persistQueryString\n          ? mergeQueryStrings(this._getContextUrl(), result.value.urlRedirect)\n          : result.value.urlRedirect;\n\n        if (isURLTargeted(url, experiment.urlPatterns)) {\n          this.log(\n            \"Skipping redirect because original URL matches redirect URL\",\n            {\n              id: experiment.key,\n            },\n          );\n          return result;\n        }\n        this._redirectedUrl = url;\n        const { navigate, delay } = this._getNavigateFunction();\n        if (navigate) {\n          if (isBrowser) {\n            // Wait for the possibly-async tracking callback, bound by min and max delays\n            Promise.all([\n              ...(trackingCall\n                ? [\n                    promiseTimeout(\n                      trackingCall,\n                      this._options.maxNavigateDelay ?? 1000,\n                    ),\n                  ]\n                : []),\n              new Promise((resolve) =>\n                window.setTimeout(\n                  resolve,\n                  this._options.navigateDelay ?? delay,\n                ),\n              ),\n            ]).then(() => {\n              try {\n                navigate(url);\n              } catch (e) {\n                console.error(e);\n              }\n            });\n          } else {\n            try {\n              navigate(url);\n            } catch (e) {\n              console.error(e);\n            }\n          }\n        }\n      } else if (changeType === \"visual\") {\n        const undo = this._options.applyDomChangesCallback\n          ? this._options.applyDomChangesCallback(result.value)\n          : this._applyDOMChanges(result.value);\n        if (undo) {\n          this._activeAutoExperiments.set(experiment, {\n            undo,\n            valueHash,\n          });\n        }\n      }\n    }\n\n    return result;\n  }\n\n  private _undoActiveAutoExperiment(exp: AutoExperiment) {\n    const data = this._activeAutoExperiments.get(exp);\n    if (data) {\n      data.undo();\n      this._activeAutoExperiments.delete(exp);\n    }\n  }\n\n  private _updateAllAutoExperiments(forceRerun?: boolean) {\n    if (!this._autoExperimentsAllowed) return;\n\n    const experiments = this._options.experiments || [];\n\n    // Stop any experiments that are no longer defined\n    const keys = new Set(experiments);\n    this._activeAutoExperiments.forEach((v, k) => {\n      if (!keys.has(k)) {\n        v.undo();\n        this._activeAutoExperiments.delete(k);\n      }\n    });\n\n    // Re-run all new/updated experiments\n    for (const exp of experiments) {\n      const result = this._runAutoExperiment(exp, forceRerun);\n\n      // Once you're in a redirect experiment, break out of the loop and don't run any further experiments\n      if (\n        result &&\n        result.inExperiment &&\n        getAutoExperimentChangeType(exp) === \"redirect\"\n      ) {\n        break;\n      }\n    }\n  }\n\n  private _onExperimentEval<T>(experiment: Experiment<T>, result: Result<T>) {\n    const prev = this._assigned.get(experiment.key);\n    this._assigned.set(experiment.key, { experiment, result });\n    if (this._subscriptions.size > 0) {\n      this._fireSubscriptions<T>(experiment, result, prev);\n    }\n  }\n\n  private _fireSubscriptions<T>(\n    experiment: Experiment<T>,\n    result: Result<T>,\n    // eslint-disable-next-line\n    prev?: { experiment: Experiment<any>; result: Result<any> },\n  ) {\n    // If assigned variation has changed, fire subscriptions\n    // TODO: what if the experiment definition has changed?\n    if (\n      !prev ||\n      prev.result.inExperiment !== result.inExperiment ||\n      prev.result.variationId !== result.variationId\n    ) {\n      this._subscriptions.forEach((cb) => {\n        try {\n          cb(experiment, result);\n        } catch (e) {\n          console.error(e);\n        }\n      });\n    }\n  }\n\n  private _recordChangedId(id: string) {\n    this._completedChangeIds.add(id);\n  }\n\n  public isOn<K extends string & keyof AppFeatures = string>(key: K): boolean {\n    return this.evalFeature(key).on;\n  }\n\n  public isOff<K extends string & keyof AppFeatures = string>(key: K): boolean {\n    return this.evalFeature(key).off;\n  }\n\n  public getFeatureValue<\n    V extends AppFeatures[K],\n    K extends string & keyof AppFeatures = string,\n  >(key: K, defaultValue: V): WidenPrimitives<V> {\n    const value = this.evalFeature<WidenPrimitives<V>, K>(key).value;\n    return value === null ? (defaultValue as WidenPrimitives<V>) : value;\n  }\n\n  /**\n   * @deprecated Use {@link evalFeature}\n   * @param id\n   */\n\n  public feature<\n    V extends AppFeatures[K],\n    K extends string & keyof AppFeatures = string,\n  >(id: K): FeatureResult<V | null> {\n    return this.evalFeature(id);\n  }\n\n  public evalFeature<\n    V extends AppFeatures[K],\n    K extends string & keyof AppFeatures = string,\n  >(id: K): FeatureResult<V | null> {\n    return _evalFeature(id, this._getEvalContext());\n  }\n\n  log(msg: string, ctx: Record<string, unknown>) {\n    if (!this.debug) return;\n    if (this._options.log) this._options.log(msg, ctx);\n    else console.log(msg, ctx);\n  }\n\n  public getDeferredTrackingCalls(): TrackingData[] {\n    return Array.from(this._deferredTrackingCalls.values());\n  }\n\n  public setDeferredTrackingCalls(calls: TrackingData[]) {\n    this._deferredTrackingCalls = new Map(\n      calls\n        .filter((c) => c && c.experiment && c.result)\n        .map((c) => {\n          return [getExperimentDedupeKey(c.experiment, c.result), c];\n        }),\n    );\n  }\n\n  public async fireDeferredTrackingCalls() {\n    if (!this._options.trackingCallback) return;\n\n    const promises: ReturnType<TrackingCallback>[] = [];\n    this._deferredTrackingCalls.forEach((call: TrackingData) => {\n      if (!call || !call.experiment || !call.result) {\n        console.error(\"Invalid deferred tracking call\", { call: call });\n      } else {\n        promises.push(\n          (this._options.trackingCallback as TrackingCallback)(\n            call.experiment,\n            call.result,\n          ),\n        );\n      }\n    });\n    this._deferredTrackingCalls.clear();\n    await Promise.all(promises);\n  }\n\n  public setTrackingCallback(callback: TrackingCallback) {\n    this._options.trackingCallback = callback;\n    this.fireDeferredTrackingCalls();\n  }\n\n  public setFeatureUsageCallback(callback: FeatureUsageCallback) {\n    this._options.onFeatureUsage = callback;\n  }\n\n  public setEventLogger(logger: EventLogger) {\n    this._options.eventLogger = logger;\n  }\n\n  public async logEvent(\n    eventName: string,\n    properties?: Record<string, unknown>,\n  ) {\n    if (this._destroyed) {\n      console.error(\"Cannot log event to destroyed GrowthBook instance\");\n      return;\n    }\n    if (this._options.enableDevMode) {\n      this.logs.push({\n        eventName,\n        properties,\n        timestamp: Date.now().toString(),\n        logType: \"event\",\n      });\n    }\n    if (this._options.eventLogger) {\n      try {\n        await this._options.eventLogger(\n          eventName,\n          properties || {},\n          this._getUserContext(),\n        );\n      } catch (e) {\n        console.error(e);\n      }\n    } else {\n      console.error(\"No event logger configured\");\n    }\n  }\n\n  private _saveDeferredTrack(data: TrackingData) {\n    this._deferredTrackingCalls.set(\n      getExperimentDedupeKey(data.experiment, data.result),\n      data,\n    );\n  }\n\n  private _getContextUrl() {\n    return this._options.url || (isBrowser ? window.location.href : \"\");\n  }\n\n  private _isAutoExperimentBlockedByContext(\n    experiment: AutoExperiment,\n  ): boolean {\n    const changeType = getAutoExperimentChangeType(experiment);\n    if (changeType === \"visual\") {\n      if (this._options.disableVisualExperiments) return true;\n\n      if (this._options.disableJsInjection) {\n        if (experiment.variations.some((v) => v.js)) {\n          return true;\n        }\n      }\n    } else if (changeType === \"redirect\") {\n      if (this._options.disableUrlRedirectExperiments) return true;\n\n      // Validate URLs\n      try {\n        const current = new URL(this._getContextUrl());\n        for (const v of experiment.variations) {\n          if (!v || !v.urlRedirect) continue;\n          const url = new URL(v.urlRedirect);\n\n          // If we're blocking cross origin redirects, block if the protocol or host is different\n          if (this._options.disableCrossOriginUrlRedirectExperiments) {\n            if (url.protocol !== current.protocol) return true;\n            if (url.host !== current.host) return true;\n          }\n        }\n      } catch (e) {\n        // Problem parsing one of the URLs\n        this.log(\"Error parsing current or redirect URL\", {\n          id: experiment.key,\n          error: e,\n        });\n        return true;\n      }\n    } else {\n      // Block any unknown changeTypes\n      return true;\n    }\n\n    if (\n      experiment.changeId &&\n      (this._options.blockedChangeIds || []).includes(experiment.changeId)\n    ) {\n      return true;\n    }\n\n    return false;\n  }\n\n  public getRedirectUrl(): string {\n    return this._redirectedUrl;\n  }\n\n  private _getNavigateFunction(): {\n    navigate: null | ((url: string) => void | Promise<void>);\n    delay: number;\n  } {\n    if (this._options.navigate) {\n      return {\n        navigate: this._options.navigate,\n        delay: 0,\n      };\n    } else if (isBrowser) {\n      return {\n        navigate: (url: string) => {\n          window.location.replace(url);\n        },\n        delay: 100,\n      };\n    }\n    return {\n      navigate: null,\n      delay: 0,\n    };\n  }\n\n  private _applyDOMChanges(changes: AutoExperimentVariation) {\n    if (!isBrowser) return;\n    const undo: (() => void)[] = [];\n    if (changes.css) {\n      const s = document.createElement(\"style\");\n      s.innerHTML = changes.css;\n      document.head.appendChild(s);\n      undo.push(() => s.remove());\n    }\n    if (changes.js) {\n      const script = document.createElement(\"script\");\n      script.innerHTML = changes.js;\n      if (this._options.jsInjectionNonce) {\n        script.nonce = this._options.jsInjectionNonce;\n      }\n      document.head.appendChild(script);\n      undo.push(() => script.remove());\n    }\n    if (changes.domMutations) {\n      changes.domMutations.forEach((mutation) => {\n        undo.push(mutate.declarative(mutation as DeclarativeMutation).revert);\n      });\n    }\n    return () => {\n      undo.forEach((fn) => fn());\n    };\n  }\n\n  public async refreshStickyBuckets(data?: FeatureApiResponse) {\n    if (this._options.stickyBucketService) {\n      const ctx = this._getEvalContext();\n      const docs = await getAllStickyBucketAssignmentDocs(\n        ctx,\n        this._options.stickyBucketService,\n        data,\n      );\n      this._options.stickyBucketAssignmentDocs = docs;\n    }\n  }\n\n  public generateStickyBucketAssignmentDocsSync(\n    stickyBucketService: StickyBucketServiceSync,\n    payload: FeatureApiResponse,\n  ) {\n    if (!(\"getAllAssignmentsSync\" in stickyBucketService)) {\n      console.error(\n        \"generating StickyBucketAssignmentDocs docs requires StickyBucketServiceSync\",\n      );\n      return;\n    }\n    const ctx = this._getEvalContext();\n    const attributes = getStickyBucketAttributes(ctx, payload);\n    return stickyBucketService.getAllAssignmentsSync(attributes);\n  }\n\n  public inDevMode(): boolean {\n    return !!this._options.enableDevMode;\n  }\n}\n\nexport async function prefetchPayload(options: PrefetchOptions) {\n  // Create a temporary instance, just to fetch the payload\n  const instance = new GrowthBook(options);\n\n  await refreshFeatures({\n    instance,\n    skipCache: options.skipCache,\n    allowStale: false,\n    backgroundSync: options.streaming,\n  });\n\n  instance.destroy();\n}\n","import type {\n  ApiHost,\n  Attributes,\n  AutoExperiment,\n  ClientKey,\n  ClientOptions,\n  DestroyOptions,\n  EvalContext,\n  EventLogger,\n  EventProperties,\n  Experiment,\n  FeatureApiResponse,\n  FeatureDefinitions,\n  FeatureResult,\n  GlobalContext,\n  InitOptions,\n  InitResponse,\n  InitSyncOptions,\n  LogUnion,\n  Plugin,\n  RefreshFeaturesOptions,\n  Result,\n  TrackingCallback,\n  TrackingCallbackWithUser,\n  UserContext,\n  WidenPrimitives,\n} from \"./types/growthbook\";\nimport { loadSDKVersion } from \"./util\";\nimport {\n  clearAutoRefresh,\n  configureCache,\n  refreshFeatures,\n  startStreaming,\n  unsubscribe,\n} from \"./feature-repository\";\nimport {\n  decryptPayload,\n  evalFeature as _evalFeature,\n  getAllStickyBucketAssignmentDocs,\n  getApiHosts,\n  runExperiment,\n} from \"./core\";\nimport { StickyBucketService } from \"./sticky-bucket-service\";\n\nconst SDK_VERSION = loadSDKVersion();\n\nexport class GrowthBookClient<\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  AppFeatures extends Record<string, any> = Record<string, any>,\n> {\n  public debug: boolean;\n  public ready: boolean;\n  public version: string;\n\n  // Properties and methods that start with \"_\" are mangled by Terser (saves ~150 bytes)\n  private _options: ClientOptions;\n\n  private _features: FeatureDefinitions;\n  private _experiments: AutoExperiment[];\n  private _payload: FeatureApiResponse | undefined;\n  private _decryptedPayload: FeatureApiResponse | undefined;\n  private _destroyed?: boolean;\n\n  constructor(options?: ClientOptions) {\n    options = options || {};\n    // These properties are all initialized in the constructor instead of above\n    // This saves ~80 bytes in the final output\n    this.version = SDK_VERSION;\n    this._options = options;\n    this.debug = !!options.debug;\n    this.ready = false;\n    this._features = {};\n    this._experiments = [];\n\n    this.log = this.log.bind(this);\n\n    if (options.plugins) {\n      for (const plugin of options.plugins) {\n        plugin(this);\n      }\n    }\n  }\n\n  public async setPayload(payload: FeatureApiResponse): Promise<void> {\n    this._payload = payload;\n    const data = await decryptPayload(payload, this._options.decryptionKey);\n    this._decryptedPayload = data;\n    if (data.features) {\n      this._features = data.features;\n    }\n    if (data.experiments) {\n      this._experiments = data.experiments;\n    }\n    if (data.savedGroups) {\n      this._options.savedGroups = data.savedGroups;\n    }\n    this.ready = true;\n  }\n\n  public initSync(options: InitSyncOptions): GrowthBookClient<AppFeatures> {\n    const payload = options.payload;\n\n    if (payload.encryptedExperiments || payload.encryptedFeatures) {\n      throw new Error(\"initSync does not support encrypted payloads\");\n    }\n\n    this._payload = payload;\n    this._decryptedPayload = payload;\n    if (payload.features) {\n      this._features = payload.features;\n    }\n    if (payload.experiments) {\n      this._experiments = payload.experiments;\n    }\n\n    this.ready = true;\n\n    startStreaming(this, options);\n\n    return this;\n  }\n\n  public async init(options?: InitOptions): Promise<InitResponse> {\n    options = options || {};\n\n    if (options.cacheSettings) {\n      configureCache(options.cacheSettings);\n    }\n\n    if (options.payload) {\n      await this.setPayload(options.payload);\n      startStreaming(this, options);\n      return {\n        success: true,\n        source: \"init\",\n      };\n    } else {\n      const { data, ...res } = await this._refresh({\n        ...options,\n        allowStale: true,\n      });\n      startStreaming(this, options);\n      await this.setPayload(data || {});\n      return res;\n    }\n  }\n\n  public async refreshFeatures(\n    options?: RefreshFeaturesOptions,\n  ): Promise<void> {\n    const res = await this._refresh({\n      ...(options || {}),\n      allowStale: false,\n    });\n    if (res.data) {\n      await this.setPayload(res.data);\n    }\n  }\n\n  public getApiInfo(): [ApiHost, ClientKey] {\n    return [this.getApiHosts().apiHost, this.getClientKey()];\n  }\n  public getApiHosts() {\n    return getApiHosts(this._options);\n  }\n  public getClientKey(): string {\n    return this._options.clientKey || \"\";\n  }\n  public getPayload(): FeatureApiResponse {\n    return (\n      this._payload || {\n        features: this.getFeatures(),\n        experiments: this._experiments || [],\n      }\n    );\n  }\n  public getDecryptedPayload(): FeatureApiResponse {\n    return this._decryptedPayload || this.getPayload();\n  }\n\n  private async _refresh({\n    timeout,\n    skipCache,\n    allowStale,\n    streaming,\n  }: RefreshFeaturesOptions & {\n    allowStale?: boolean;\n    streaming?: boolean;\n  }) {\n    if (!this._options.clientKey) {\n      throw new Error(\"Missing clientKey\");\n    }\n    // Trigger refresh in feature repository\n    return refreshFeatures({\n      instance: this,\n      timeout,\n      skipCache: skipCache || this._options.disableCache,\n      allowStale,\n      backgroundSync: streaming ?? true,\n    });\n  }\n\n  public getFeatures() {\n    return this._features || {};\n  }\n\n  public getGlobalAttributes(): Attributes {\n    return this._options.globalAttributes || {};\n  }\n  public setGlobalAttributes(attributes: Attributes) {\n    this._options.globalAttributes = attributes;\n  }\n\n  public destroy(options?: DestroyOptions) {\n    options = options || {};\n    this._destroyed = true;\n    unsubscribe(this);\n    if (options.destroyAllStreams) {\n      clearAutoRefresh();\n    }\n\n    // Release references to save memory\n    this._features = {};\n    this._experiments = [];\n    this._decryptedPayload = undefined;\n    this._payload = undefined;\n    this._options = {};\n  }\n\n  public isDestroyed() {\n    return !!this._destroyed;\n  }\n\n  public setEventLogger(logger: EventLogger) {\n    this._options.eventLogger = logger;\n  }\n\n  public logEvent(\n    eventName: string,\n    properties: EventProperties,\n    userContext: UserContext,\n  ) {\n    if (this._options.eventLogger) {\n      const ctx = this._getEvalContext(userContext);\n      this._options.eventLogger(eventName, properties, ctx.user);\n    }\n  }\n\n  public runInlineExperiment<T>(\n    experiment: Experiment<T>,\n    userContext: UserContext,\n  ): Result<T> {\n    const { result } = runExperiment(\n      experiment,\n      null,\n      this._getEvalContext(userContext),\n    );\n    return result;\n  }\n\n  private _getEvalContext(userContext: UserContext): EvalContext {\n    if (this._options.globalAttributes) {\n      userContext = {\n        ...userContext,\n        attributes: {\n          ...this._options.globalAttributes,\n          ...userContext.attributes,\n        },\n      };\n    }\n\n    return {\n      user: userContext,\n      global: this._getGlobalContext(),\n      stack: {\n        evaluatedFeatures: new Set(),\n      },\n    };\n  }\n\n  private _getGlobalContext(): GlobalContext {\n    return {\n      features: this._features,\n      experiments: this._experiments,\n      log: this.log,\n      enabled: this._options.enabled,\n      qaMode: this._options.qaMode,\n      savedGroups: this._options.savedGroups,\n      forcedFeatureValues: this._options.forcedFeatureValues,\n      forcedVariations: this._options.forcedVariations,\n      trackingCallback: this._options.trackingCallback,\n      onFeatureUsage: this._options.onFeatureUsage,\n    };\n  }\n\n  public isOn<K extends string & keyof AppFeatures = string>(\n    key: K,\n    userContext: UserContext,\n  ): boolean {\n    return this.evalFeature(key, userContext).on;\n  }\n\n  public isOff<K extends string & keyof AppFeatures = string>(\n    key: K,\n    userContext: UserContext,\n  ): boolean {\n    return this.evalFeature(key, userContext).off;\n  }\n\n  public getFeatureValue<\n    V extends AppFeatures[K],\n    K extends string & keyof AppFeatures = string,\n  >(key: K, defaultValue: V, userContext: UserContext): WidenPrimitives<V> {\n    const value = this.evalFeature<WidenPrimitives<V>, K>(\n      key,\n      userContext,\n    ).value;\n    return value === null ? (defaultValue as WidenPrimitives<V>) : value;\n  }\n\n  public evalFeature<\n    V extends AppFeatures[K],\n    K extends string & keyof AppFeatures = string,\n  >(id: K, userContext: UserContext): FeatureResult<V | null> {\n    return _evalFeature(id, this._getEvalContext(userContext));\n  }\n\n  log(msg: string, ctx: Record<string, unknown>) {\n    if (!this.debug) return;\n    if (this._options.log) this._options.log(msg, ctx);\n    else console.log(msg, ctx);\n  }\n\n  public setTrackingCallback(callback: TrackingCallbackWithUser) {\n    this._options.trackingCallback = callback;\n  }\n\n  public async applyStickyBuckets(\n    partialContext: Omit<\n      UserContext,\n      \"stickyBucketService\" | \"stickyBucketAssignmentDocs\"\n    >,\n    stickyBucketService: StickyBucketService,\n  ): Promise<UserContext> {\n    const ctx = this._getEvalContext(partialContext);\n\n    const stickyBucketAssignmentDocs = await getAllStickyBucketAssignmentDocs(\n      ctx,\n      stickyBucketService,\n    );\n\n    return {\n      ...partialContext,\n      stickyBucketAssignmentDocs,\n      saveStickyBucketAssignmentDoc: (doc) =>\n        stickyBucketService.saveAssignments(doc),\n    };\n  }\n\n  public createScopedInstance(\n    userContext: UserContext,\n    userPlugins?: Plugin[],\n  ) {\n    return new UserScopedGrowthBook(this, userContext, [\n      ...(this._options.plugins || []),\n      ...(userPlugins || []),\n    ]);\n  }\n}\n\nexport class UserScopedGrowthBook<\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  AppFeatures extends Record<string, any> = Record<string, any>,\n> {\n  private _gb: GrowthBookClient;\n  private _userContext: UserContext;\n  public logs: Array<LogUnion>;\n\n  constructor(\n    gb: GrowthBookClient<AppFeatures>,\n    userContext: UserContext,\n    plugins?: Plugin[],\n  ) {\n    this._gb = gb;\n    this._userContext = userContext;\n    this.logs = [];\n\n    this._userContext.trackedExperiments =\n      this._userContext.trackedExperiments || new Set();\n    this._userContext.trackedFeatureUsage =\n      this._userContext.trackedFeatureUsage || {};\n    this._userContext.devLogs = this.logs;\n\n    if (plugins) {\n      for (const plugin of plugins) {\n        plugin(this);\n      }\n    }\n  }\n\n  public runInlineExperiment<T>(experiment: Experiment<T>): Result<T> {\n    return this._gb.runInlineExperiment(experiment, this._userContext);\n  }\n\n  public isOn<K extends string & keyof AppFeatures = string>(key: K): boolean {\n    return this._gb.isOn(key, this._userContext);\n  }\n\n  public isOff<K extends string & keyof AppFeatures = string>(key: K): boolean {\n    return this._gb.isOff(key, this._userContext);\n  }\n\n  public getFeatureValue<\n    V extends AppFeatures[K],\n    K extends string & keyof AppFeatures = string,\n  >(key: K, defaultValue: V): WidenPrimitives<V> {\n    return this._gb.getFeatureValue(key, defaultValue, this._userContext);\n  }\n\n  public evalFeature<\n    V extends AppFeatures[K],\n    K extends string & keyof AppFeatures = string,\n  >(id: K): FeatureResult<V | null> {\n    return this._gb.evalFeature(id, this._userContext);\n  }\n\n  public logEvent(eventName: string, properties?: EventProperties) {\n    if (this._userContext.enableDevMode) {\n      this.logs.push({\n        eventName,\n        properties,\n        timestamp: Date.now().toString(),\n        logType: \"event\",\n      });\n    }\n    this._gb.logEvent(eventName, properties || {}, this._userContext);\n  }\n\n  public setTrackingCallback(cb: TrackingCallback) {\n    this._userContext.trackingCallback = cb;\n  }\n  public getApiInfo(): [ApiHost, ClientKey] {\n    return this._gb.getApiInfo();\n  }\n  public getClientKey() {\n    return this._gb.getClientKey();\n  }\n  public setURL(url: string) {\n    this._userContext.url = url;\n  }\n  public updateAttributes(attributes: Attributes) {\n    this._userContext.attributes = {\n      ...this._userContext.attributes,\n      ...attributes,\n    };\n  }\n  public setAttributeOverrides(overrides: Attributes) {\n    this._userContext.attributeOverrides = overrides;\n  }\n  public async setForcedVariations(vars: Record<string, number>) {\n    this._userContext.forcedVariations = vars || {};\n  }\n  // eslint-disable-next-line\n  public setForcedFeatures(map: Map<string, any>) {\n    this._userContext.forcedFeatureValues = map;\n  }\n  public getUserContext() {\n    return this._userContext;\n  }\n  public getVersion() {\n    return SDK_VERSION;\n  }\n  public getDecryptedPayload() {\n    return this._gb.getDecryptedPayload();\n  }\n  public inDevMode(): boolean {\n    return !!this._userContext.enableDevMode;\n  }\n}\n","import {\n  LocalStorageCompat,\n  StickyAssignmentsDocument,\n  StickyAttributeKey,\n} from \"./types/growthbook\";\nimport { toString } from \"./util\";\nimport { getStickyBucketAttributeKey } from \"./core\";\n\nexport interface CookieAttributes {\n  expires?: number | Date | undefined;\n  path?: string | undefined;\n  domain?: string | undefined;\n  secure?: boolean | undefined;\n  sameSite?: \"strict\" | \"Strict\" | \"lax\" | \"Lax\" | \"none\" | \"None\" | undefined;\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  [property: string]: any;\n}\nexport interface JsCookiesCompat<T = string> {\n  set(\n    name: string,\n    value: string | T,\n    options?: CookieAttributes,\n  ): string | undefined;\n  get(name: string): string | T | undefined;\n  get(): { [key: string]: string };\n  remove(name: string, options?: CookieAttributes): void;\n}\n\nexport interface IORedisCompat {\n  mget(...keys: string[]): Promise<string[]>;\n  set(key: string, value: string): Promise<string>;\n}\n\nexport interface RequestCompat {\n  cookies: Record<string, string>;\n  [key: string]: unknown;\n}\nexport interface ResponseCompat {\n  cookie(\n    name: string,\n    value: string,\n    options?: CookieAttributes,\n  ): ResponseCompat;\n  [key: string]: unknown;\n}\n\n/**\n * Responsible for reading and writing documents which describe sticky bucket assignments.\n */\nexport abstract class StickyBucketService {\n  protected prefix: string;\n\n  constructor(opts?: { prefix?: string }) {\n    opts = opts || {};\n    this.prefix = opts.prefix || \"\";\n  }\n\n  abstract getAssignments(\n    attributeName: string,\n    attributeValue: string,\n  ): Promise<StickyAssignmentsDocument | null>;\n\n  abstract saveAssignments(doc: StickyAssignmentsDocument): Promise<unknown>;\n\n  /**\n   * The SDK calls getAllAssignments to populate sticky buckets. This in turn will\n   * typically loop through individual getAssignments calls. However, some StickyBucketService\n   * instances (i.e. Redis) will instead perform a multi-query inside getAllAssignments instead.\n   */\n  async getAllAssignments(\n    attributes: Record<string, string>,\n  ): Promise<Record<StickyAttributeKey, StickyAssignmentsDocument>> {\n    const docs: Record<string, StickyAssignmentsDocument> = {};\n    (\n      await Promise.all(\n        Object.entries(attributes).map(([attributeName, attributeValue]) =>\n          this.getAssignments(attributeName, attributeValue),\n        ),\n      )\n    ).forEach((doc) => {\n      if (doc) {\n        const key = getStickyBucketAttributeKey(\n          doc.attributeName,\n          doc.attributeValue,\n        );\n        docs[key] = doc;\n      }\n    });\n    return docs;\n  }\n\n  getKey(attributeName: string, attributeValue: string): string {\n    return `${this.prefix}${attributeName}||${attributeValue}`;\n  }\n}\n\nexport abstract class StickyBucketServiceSync extends StickyBucketService {\n  abstract getAssignmentsSync(\n    attributeName: string,\n    attributeValue: string,\n  ): StickyAssignmentsDocument | null;\n\n  abstract saveAssignmentsSync(doc: StickyAssignmentsDocument): void;\n\n  async getAssignments(attributeName: string, attributeValue: string) {\n    return this.getAssignmentsSync(attributeName, attributeValue);\n  }\n\n  async saveAssignments(doc: StickyAssignmentsDocument) {\n    this.saveAssignmentsSync(doc);\n  }\n\n  getAllAssignmentsSync(\n    attributes: Record<string, string>,\n  ): Record<StickyAttributeKey, StickyAssignmentsDocument> {\n    const docs: Record<string, StickyAssignmentsDocument> = {};\n    Object.entries(attributes)\n      .map(([attributeName, attributeValue]) =>\n        this.getAssignmentsSync(attributeName, attributeValue),\n      )\n      .forEach((doc) => {\n        if (doc) {\n          const key = getStickyBucketAttributeKey(\n            doc.attributeName,\n            doc.attributeValue,\n          );\n          docs[key] = doc;\n        }\n      });\n    return docs;\n  }\n}\n\nexport class LocalStorageStickyBucketService extends StickyBucketService {\n  private localStorage: LocalStorageCompat | undefined;\n  constructor(opts?: { prefix?: string; localStorage?: LocalStorageCompat }) {\n    opts = opts || {};\n    super();\n    this.prefix = opts.prefix || \"gbStickyBuckets__\";\n    try {\n      this.localStorage = opts.localStorage || globalThis.localStorage;\n    } catch (e) {\n      // Ignore localStorage errors\n    }\n  }\n  async getAssignments(attributeName: string, attributeValue: string) {\n    const key = this.getKey(attributeName, attributeValue);\n    let doc: StickyAssignmentsDocument | null = null;\n    if (!this.localStorage) return doc;\n    try {\n      const raw = (await this.localStorage.getItem(key)) || \"{}\";\n      const data = JSON.parse(raw);\n      if (data.attributeName && data.attributeValue && data.assignments) {\n        doc = data;\n      }\n    } catch (e) {\n      // Ignore localStorage errors\n    }\n    return doc;\n  }\n  async saveAssignments(doc: StickyAssignmentsDocument) {\n    const key = this.getKey(doc.attributeName, doc.attributeValue);\n    if (!this.localStorage) return;\n    try {\n      await this.localStorage.setItem(key, JSON.stringify(doc));\n    } catch (e) {\n      // Ignore localStorage errors\n    }\n  }\n}\n\nexport class ExpressCookieStickyBucketService extends StickyBucketServiceSync {\n  /**\n   * Intended to be used with cookieParser() middleware from npm: 'cookie-parser'.\n   * Assumes:\n   *  - reading a cookie is automatically decoded via decodeURIComponent() or similar\n   *  - writing a cookie name & value must be manually encoded via encodeURIComponent() or similar\n   *  - all cookie bodies are JSON encoded strings and are manually encoded/decoded\n   */\n  private req: RequestCompat;\n  private res: ResponseCompat;\n  private cookieAttributes: CookieAttributes;\n  constructor({\n    prefix = \"gbStickyBuckets__\",\n    req,\n    res,\n    cookieAttributes = { maxAge: 180 * 24 * 3600 * 1000 }, // 180 days\n  }: {\n    prefix?: string;\n    req: RequestCompat;\n    res: ResponseCompat;\n    cookieAttributes?: CookieAttributes;\n  }) {\n    super();\n    this.prefix = prefix;\n    this.req = req;\n    this.res = res;\n    this.cookieAttributes = cookieAttributes;\n  }\n  getAssignmentsSync(attributeName: string, attributeValue: string) {\n    const key = this.getKey(attributeName, attributeValue);\n    let doc: StickyAssignmentsDocument | null = null;\n    if (!this.req) return doc;\n    try {\n      const raw = this.req.cookies[key] || \"{}\";\n      const data = JSON.parse(raw);\n      if (data.attributeName && data.attributeValue && data.assignments) {\n        doc = data;\n      }\n    } catch (e) {\n      // Ignore cookie errors\n    }\n    return doc;\n  }\n  saveAssignmentsSync(doc: StickyAssignmentsDocument) {\n    const key = this.getKey(doc.attributeName, doc.attributeValue);\n    if (!this.res) return;\n    const str = JSON.stringify(doc);\n    this.res.cookie(\n      encodeURIComponent(key),\n      encodeURIComponent(str),\n      this.cookieAttributes,\n    );\n  }\n}\n\nexport class BrowserCookieStickyBucketService extends StickyBucketServiceSync {\n  /**\n   * Intended to be used with npm: 'js-cookie'.\n   * Assumes:\n   *  - reading a cookie is automatically decoded via decodeURIComponent() or similar\n   *  - writing a cookie name & value is automatically encoded via encodeURIComponent() or similar\n   *  - all cookie bodies are JSON encoded strings and are manually encoded/decoded\n   */\n  private jsCookie: JsCookiesCompat;\n  private cookieAttributes: CookieAttributes;\n  constructor({\n    prefix = \"gbStickyBuckets__\",\n    jsCookie,\n    cookieAttributes = { expires: 180 }, // 180 days\n  }: {\n    prefix?: string;\n    jsCookie: JsCookiesCompat;\n    cookieAttributes?: CookieAttributes;\n  }) {\n    super();\n    this.prefix = prefix;\n    this.jsCookie = jsCookie;\n    this.cookieAttributes = cookieAttributes;\n  }\n  getAssignmentsSync(attributeName: string, attributeValue: string) {\n    const key = this.getKey(attributeName, attributeValue);\n    let doc: StickyAssignmentsDocument | null = null;\n    if (!this.jsCookie) return doc;\n    try {\n      const raw = this.jsCookie.get(key);\n      const data = JSON.parse(raw || \"{}\");\n      if (data.attributeName && data.attributeValue && data.assignments) {\n        doc = data;\n      }\n    } catch (e) {\n      // Ignore cookie errors\n    }\n    return doc;\n  }\n  async saveAssignmentsSync(doc: StickyAssignmentsDocument) {\n    const key = this.getKey(doc.attributeName, doc.attributeValue);\n    if (!this.jsCookie) return;\n    const str = JSON.stringify(doc);\n    this.jsCookie.set(key, str, this.cookieAttributes);\n  }\n}\n\nexport class RedisStickyBucketService extends StickyBucketService {\n  /** Intended to be used with npm: 'ioredis'. **/\n  private redis: IORedisCompat | undefined;\n  constructor({ redis }: { redis: IORedisCompat }) {\n    super();\n    this.redis = redis;\n  }\n  async getAllAssignments(\n    attributes: Record<string, string>,\n  ): Promise<Record<StickyAttributeKey, StickyAssignmentsDocument>> {\n    const docs: Record<StickyAttributeKey, StickyAssignmentsDocument> = {};\n    const keys = Object.entries(attributes).map(\n      ([attributeName, attributeValue]) =>\n        getStickyBucketAttributeKey(attributeName, attributeValue),\n    );\n    if (!this.redis) return docs;\n    await this.redis.mget(...keys).then((values) => {\n      values.forEach((raw) => {\n        try {\n          const data = JSON.parse(raw || \"{}\");\n          if (\n            data.attributeName &&\n            \"attributeValue\" in data &&\n            data.assignments\n          ) {\n            const key = getStickyBucketAttributeKey(\n              data.attributeName,\n              toString(data.attributeValue),\n            );\n            docs[key] = data;\n          }\n        } catch (e) {\n          // ignore redis doc parse errors\n        }\n      });\n    });\n    return docs;\n  }\n  async getAssignments(_attributeName: string, _attributeValue: string) {\n    // not implemented\n    return null;\n  }\n  async saveAssignments(doc: StickyAssignmentsDocument) {\n    const key = this.getKey(doc.attributeName, doc.attributeValue);\n    if (!this.redis) return;\n    await this.redis.set(key, JSON.stringify(doc));\n  }\n}\n"],"names":["polyfills","fetch","globalThis","bind","undefined","SubtleCrypto","crypto","subtle","EventSource","getPolyfills","hashFnv32a","str","hval","l","length","i","charCodeAt","hash","seed","value","version","inRange","n","range","getUrlRegExp","regexString","escaped","replace","RegExp","e","console","error","isURLTargeted","url","targets","hasIncludeRules","isIncluded","match","_evalURLTarget","type","pattern","include","parsed","URL","regex","test","href","substring","origin","actual","expected","comps","host","pathname","push","searchParams","forEach","v","k","get","some","data","isPath","_evalSimpleUrlPart","_evalSimpleUrlTarget","base64ToBuf","b","Uint8Array","from","atob","c","async","decrypt","encryptedString","decryptionKey","Error","key","importKey","name","iv","cipherText","split","plainTextBuffer","TextDecoder","decode","toString","input","JSON","stringify","paddedVersionString","parts","map","padStart","join","loadSDKVersion","isObj","x","getAutoExperimentChangeType","exp","urlPatterns","variations","variation","domMutations","promiseTimeout","promise","timeout","Promise","resolve","timer","resolved","finish","clearTimeout","setTimeout","then","catch","cacheSettings","staleTTL","maxAge","cacheKey","backgroundSync","maxEntries","disableIdleStreams","idleStreamInterval","disableCache","helpers","fetchFeaturesCall","clientKey","headers","fetchRemoteEvalCall","payload","options","method","body","eventSourceCall","startIdleListener","idleTimeout","window","document","onVisibilityChange","visibilityState","onVisible","onHidden","addEventListener","removeEventListener","stopIdleListener","localStorage","subscribedInstances","Map","cacheInitialized","cache","activeFetches","streams","supportsSSE","Set","configureCache","overrides","Object","assign","clearAutoRefresh","refreshFeatures","instance","skipCache","allowStale","getKey","getCacheKey","now","Date","minStaleAt","getTime","getItem","parse","Array","isArray","set","staleAt","cleanupCache","cleanupFn","initializeCache","existing","sse","add","fetchFeatures","startAutoRefresh","success","source","fetchFeaturesWithCache","unsubscribe","s","delete","channel","state","disableChannel","enableChannel","updatePersistentCache","setItem","entries","apiHost","getApiInfo","baseKey","isRemoteEval","attributes","getAttributes","cacheKeyAttributes","getCacheKeyAttributes","keys","ca","fv","getForcedVariations","getUrl","entriesWithTimestamps","sort","a","entriesToRemoveCount","Math","min","max","size","onNewFeatureData","dateUpdated","has","instances","setPayload","getPayload","refreshInstance","apiRequestHeaders","getApiHosts","getClientKey","remoteEval","forcedVariations","forcedFeatures","getForcedFeatures","res","ok","status","json","forceSSE","streamingHost","streamingHostRequestHeaders","src","cb","event","errors","onSSEError","readyState","delay","pow","random","includes","onopen","onerror","close","destroyChannel","clear","startStreaming","streaming","subs","subscribe","validAttributeName","nullController","revert","elements","mutations","getElementRecord","element","record","createElementPropertyRecord","el","attr","getCurrentValue","setValue","mutationRunner","currentValue","isDirty","originalValue","virtualValue","_positionTimeout","observer","MutationObserver","parentNode","insertBeforeNode","observe","childList","subtree","characterData","attributeFilter","getObserverInit","queueIfNeeded","val","currentVal","runDOMUpdates","htmlMutationRunner","m","mutate","html","transformContainer","createElement","innerHTML","getTransformedHTML","classMutationRunner","filter","Boolean","attrMutationRunner","positionMutationRunner","newNodes","_ref","insertBeforeSelector","querySelector","parentSelector","_loadDOMNodes","getHTMLValue","setHTMLValue","getElementHTMLRecord","elementRecord","getElementPosition","parentElement","nextElementSibling","setElementPosition","contains","insertBefore","getElementPositionRecord","position","setClassValue","className","removeAttribute","getClassValue","getElementClassRecord","classes","getElementAttributeRecord","attrName","_el$getAttribute","getAttribute","setAttribute","setAttrValue","setPropertyValue","_element$html","_element$html$observe","disconnect","_element$classes","_element$classes$obse","_element$position","_element$position$obs","_element$attributes","_element$attributes$a","_element$attributes$a2","deleteElementPropertyRecord","refreshElementsSet","mutation","kind","existingElements","querySelectorAll","selector","attribute","startMutating","refreshAllElementSets","newMutation","index","indexOf","splice","stopMutating","classnames","mutatedClassnames","documentElement","_regexCache","evalCondition","obj","condition","savedGroups","evalOr","evalAnd","evalConditionValue","getPath","path","current","getRegex","insensitive","String","toLowerCase","isOperatorObject","op","evalOperatorCondition","isIn","caseFold","isInAll","passed","j","operator","check","elemMatch","t","getType","conditions","EVENT_FEATURE_EVALUATED","EVENT_EXPERIMENT_VIEWED","safeCall","fn","onExperimentViewed","ctx","experiment","result","user","trackedExperiments","getExperimentDedupeKey","enableDevMode","devLogs","timestamp","logType","calls","global","trackingCallback","eventLogger","experimentId","variationId","hashAttribute","hashValue","evalFeature","id","stack","evaluatedFeatures","getFeatureResult","forcedValues","ret","forcedFeatureValues","getForcedFeatureValues","features","feature","rules","rule","parentConditions","parentCondition","parentResult","gate","filters","isFilteredOut","conditionPasses","isIncludedInRollout","saveStickyBucketAssignmentDoc","disableStickyBucketing","fallbackAttribute","coverage","hashVersion","tracks","saveDeferredTrack","force","weights","bucketVersion","minBucketVersion","namespace","meta","ranges","phase","runExperiment","onExperimentEval","inExperiment","passthrough","defaultValue","featureId","numVariations","getExperimentResult","enabled","o","mergeOverrides","qsOverride","search","kv","parseInt","getQueryStringOverride","active","getHashAttribute","assigned","foundStickyBucket","stickyBucketVersionIsBlocked","versionIsBlocked","expKey","expBucketVersion","expHashAttribute","expFallbackAttribute","expMinBucketVersion","expMeta","getStickyBucketExperimentKey","assignments","stickyBucketAssignmentDocs","hashKey","getStickyBucketAttributeKey","fallbackValue","fallbackKey","getStickyBucketAssignments","variationKey","findIndex","getStickyBucketVariation","inNamespace","groups","expGroups","hasGroupOverlap","urlRegex","pathOnly","urlIsValid","chooseVariation","equal","fill","totalWeight","reduce","w","sum","cumulative","start","getBucketRanges","qaMode","changed","attrKey","doc","attributeName","attributeValue","existingAssignments","newAssignments","generateStickyBucketAssignmentDoc","trackingCalls","trackingCall","all","changeId","recordChangeId","ruleId","on","off","experimentResult","trackedFeatureUsage","stringifiedValue","featureKey","onFeatureUsage","attributeOverrides","r","variationIndex","hashUsed","bucket","stickyBucketUsed","fallback","experimentKey","experimentBucketVersion","getAllStickyBucketAssignmentDocs","stickyBucketService","getStickyBucketAttributes","getAllAssignments","stickyBucketIdentifierAttributes","experiments","deriveStickyBucketIdentifierAttributes","decryptPayload","encryptedFeatures","encryptedExperiments","encryptedSavedGroups","defaultHost","apiHostRequestHeaders","isBrowser","SDK_VERSION","GrowthBook","constructor","this","_options","context","_renderer","renderer","_trackedExperiments","_completedChangeIds","_trackedFeatures","debug","_subscriptions","ready","_assigned","_activeAutoExperiments","_triggeredExpKeys","_initialized","_redirectedUrl","_deferredTrackingCalls","_autoExperimentsAllowed","disableExperimentsOnLoad","_destroyCallbacks","logs","log","_saveDeferredTrack","_onExperimentEval","_fireSubscriptions","_recordChangedId","isGbHost","hostname","_saveStickyBucketAssignmentDoc","saveAssignments","plugins","plugin","_growthbook","dispatchEvent","Event","_updateAllAutoExperiments","refreshStickyBuckets","_payload","_decryptedPayload","_render","initSync","generateStickyBucketAssignmentDocsSync","_refresh","init","autoRefresh","subscribeToChanges","getFeatures","getExperiments","getDecryptedPayload","setFeatures","featuresJSON","setExperiments","experimentsJSON","_refreshForRemoteEval","setAttributes","vars","setForcedFeatures","getStickyBucketAssignmentDocs","getCompletedChangeIds","getAllResults","onDestroy","isDestroyed","_destroyed","destroy","destroyAllStreams","undo","setRenderer","forceVariation","run","_getEvalContext","triggerExperiment","_runAutoExperiment","triggerAutoExperiments","_getUserContext","_getGlobalContext","blockedChangeIds","_getContextUrl","forceRerun","manual","_isAutoExperimentBlockedByContext","valueHash","_undoActiveAutoExperiment","changeType","urlRedirect","persistQueryString","oldUrl","newUrl","currUrl","redirectUrl","mergeQueryStrings","navigate","_getNavigateFunction","maxNavigateDelay","navigateDelay","applyDomChangesCallback","_applyDOMChanges","prev","isOn","isOff","getFeatureValue","_evalFeature","msg","getDeferredTrackingCalls","values","setDeferredTrackingCalls","promises","call","setTrackingCallback","callback","fireDeferredTrackingCalls","setFeatureUsageCallback","setEventLogger","logger","eventName","properties","location","disableVisualExperiments","disableJsInjection","js","disableUrlRedirectExperiments","disableCrossOriginUrlRedirectExperiments","protocol","getRedirectUrl","changes","css","head","appendChild","remove","script","jsInjectionNonce","nonce","_ref2","action","docs","getAllAssignmentsSync","inDevMode","GrowthBookClient","_features","_experiments","getGlobalAttributes","globalAttributes","setGlobalAttributes","logEvent","userContext","runInlineExperiment","partialContext","createScopedInstance","userPlugins","UserScopedGrowthBook","gb","_gb","_userContext","setURL","updateAttributes","setAttributeOverrides","getUserContext","getVersion","StickyBucketService","opts","prefix","getAssignments","StickyBucketServiceSync","getAssignmentsSync","saveAssignmentsSync","jsCookie","cookieAttributes","expires","super","raw","req","cookies","cookie","encodeURIComponent","redis","mget","_attributeName","_attributeValue"],"mappings":"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","x_google_ignoreList":[2]}