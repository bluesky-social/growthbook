{"version":3,"file":"sticky-bucket-service.js","names":["_util","require","_core","StickyBucketService","constructor","opts","prefix","getAllAssignments","attributes","docs","Promise","all","Object","entries","map","attributeName","attributeValue","getAssignments","forEach","doc","key","getStickyBucketAttributeKey","getKey","exports","StickyBucketServiceSync","getAssignmentsSync","saveAssignments","saveAssignmentsSync","getAllAssignmentsSync","LocalStorageStickyBucketService","localStorage","globalThis","e","raw","getItem","data","JSON","parse","assignments","setItem","stringify","ExpressCookieStickyBucketService","req","res","cookieAttributes","maxAge","cookies","str","cookie","encodeURIComponent","BrowserCookieStickyBucketService","jsCookie","expires","get","set","RedisStickyBucketService","redis","keys","mget","then","values","toString","_attributeName","_attributeValue"],"sources":["../../src/sticky-bucket-service.ts"],"sourcesContent":["import {\n  LocalStorageCompat,\n  StickyAssignmentsDocument,\n  StickyAttributeKey,\n} from \"./types/growthbook\";\nimport { toString } from \"./util\";\nimport { getStickyBucketAttributeKey } from \"./core\";\n\nexport interface CookieAttributes {\n  expires?: number | Date | undefined;\n  path?: string | undefined;\n  domain?: string | undefined;\n  secure?: boolean | undefined;\n  sameSite?: \"strict\" | \"Strict\" | \"lax\" | \"Lax\" | \"none\" | \"None\" | undefined;\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  [property: string]: any;\n}\nexport interface JsCookiesCompat<T = string> {\n  set(\n    name: string,\n    value: string | T,\n    options?: CookieAttributes,\n  ): string | undefined;\n  get(name: string): string | T | undefined;\n  get(): { [key: string]: string };\n  remove(name: string, options?: CookieAttributes): void;\n}\n\nexport interface IORedisCompat {\n  mget(...keys: string[]): Promise<string[]>;\n  set(key: string, value: string): Promise<string>;\n}\n\nexport interface RequestCompat {\n  cookies: Record<string, string>;\n  [key: string]: unknown;\n}\nexport interface ResponseCompat {\n  cookie(\n    name: string,\n    value: string,\n    options?: CookieAttributes,\n  ): ResponseCompat;\n  [key: string]: unknown;\n}\n\n/**\n * Responsible for reading and writing documents which describe sticky bucket assignments.\n */\nexport abstract class StickyBucketService {\n  protected prefix: string;\n\n  constructor(opts?: { prefix?: string }) {\n    opts = opts || {};\n    this.prefix = opts.prefix || \"\";\n  }\n\n  abstract getAssignments(\n    attributeName: string,\n    attributeValue: string,\n  ): Promise<StickyAssignmentsDocument | null>;\n\n  abstract saveAssignments(doc: StickyAssignmentsDocument): Promise<unknown>;\n\n  /**\n   * The SDK calls getAllAssignments to populate sticky buckets. This in turn will\n   * typically loop through individual getAssignments calls. However, some StickyBucketService\n   * instances (i.e. Redis) will instead perform a multi-query inside getAllAssignments instead.\n   */\n  async getAllAssignments(\n    attributes: Record<string, string>,\n  ): Promise<Record<StickyAttributeKey, StickyAssignmentsDocument>> {\n    const docs: Record<string, StickyAssignmentsDocument> = {};\n    (\n      await Promise.all(\n        Object.entries(attributes).map(([attributeName, attributeValue]) =>\n          this.getAssignments(attributeName, attributeValue),\n        ),\n      )\n    ).forEach((doc) => {\n      if (doc) {\n        const key = getStickyBucketAttributeKey(\n          doc.attributeName,\n          doc.attributeValue,\n        );\n        docs[key] = doc;\n      }\n    });\n    return docs;\n  }\n\n  getKey(attributeName: string, attributeValue: string): string {\n    return `${this.prefix}${attributeName}||${attributeValue}`;\n  }\n}\n\nexport abstract class StickyBucketServiceSync extends StickyBucketService {\n  abstract getAssignmentsSync(\n    attributeName: string,\n    attributeValue: string,\n  ): StickyAssignmentsDocument | null;\n\n  abstract saveAssignmentsSync(doc: StickyAssignmentsDocument): void;\n\n  async getAssignments(attributeName: string, attributeValue: string) {\n    return this.getAssignmentsSync(attributeName, attributeValue);\n  }\n\n  async saveAssignments(doc: StickyAssignmentsDocument) {\n    this.saveAssignmentsSync(doc);\n  }\n\n  getAllAssignmentsSync(\n    attributes: Record<string, string>,\n  ): Record<StickyAttributeKey, StickyAssignmentsDocument> {\n    const docs: Record<string, StickyAssignmentsDocument> = {};\n    Object.entries(attributes)\n      .map(([attributeName, attributeValue]) =>\n        this.getAssignmentsSync(attributeName, attributeValue),\n      )\n      .forEach((doc) => {\n        if (doc) {\n          const key = getStickyBucketAttributeKey(\n            doc.attributeName,\n            doc.attributeValue,\n          );\n          docs[key] = doc;\n        }\n      });\n    return docs;\n  }\n}\n\nexport class LocalStorageStickyBucketService extends StickyBucketService {\n  private localStorage: LocalStorageCompat | undefined;\n  constructor(opts?: { prefix?: string; localStorage?: LocalStorageCompat }) {\n    opts = opts || {};\n    super();\n    this.prefix = opts.prefix || \"gbStickyBuckets__\";\n    try {\n      this.localStorage = opts.localStorage || globalThis.localStorage;\n    } catch (e) {\n      // Ignore localStorage errors\n    }\n  }\n  async getAssignments(attributeName: string, attributeValue: string) {\n    const key = this.getKey(attributeName, attributeValue);\n    let doc: StickyAssignmentsDocument | null = null;\n    if (!this.localStorage) return doc;\n    try {\n      const raw = (await this.localStorage.getItem(key)) || \"{}\";\n      const data = JSON.parse(raw);\n      if (data.attributeName && data.attributeValue && data.assignments) {\n        doc = data;\n      }\n    } catch (e) {\n      // Ignore localStorage errors\n    }\n    return doc;\n  }\n  async saveAssignments(doc: StickyAssignmentsDocument) {\n    const key = this.getKey(doc.attributeName, doc.attributeValue);\n    if (!this.localStorage) return;\n    try {\n      await this.localStorage.setItem(key, JSON.stringify(doc));\n    } catch (e) {\n      // Ignore localStorage errors\n    }\n  }\n}\n\nexport class ExpressCookieStickyBucketService extends StickyBucketServiceSync {\n  /**\n   * Intended to be used with cookieParser() middleware from npm: 'cookie-parser'.\n   * Assumes:\n   *  - reading a cookie is automatically decoded via decodeURIComponent() or similar\n   *  - writing a cookie name & value must be manually encoded via encodeURIComponent() or similar\n   *  - all cookie bodies are JSON encoded strings and are manually encoded/decoded\n   */\n  private req: RequestCompat;\n  private res: ResponseCompat;\n  private cookieAttributes: CookieAttributes;\n  constructor({\n    prefix = \"gbStickyBuckets__\",\n    req,\n    res,\n    cookieAttributes = { maxAge: 180 * 24 * 3600 * 1000 }, // 180 days\n  }: {\n    prefix?: string;\n    req: RequestCompat;\n    res: ResponseCompat;\n    cookieAttributes?: CookieAttributes;\n  }) {\n    super();\n    this.prefix = prefix;\n    this.req = req;\n    this.res = res;\n    this.cookieAttributes = cookieAttributes;\n  }\n  getAssignmentsSync(attributeName: string, attributeValue: string) {\n    const key = this.getKey(attributeName, attributeValue);\n    let doc: StickyAssignmentsDocument | null = null;\n    if (!this.req) return doc;\n    try {\n      const raw = this.req.cookies[key] || \"{}\";\n      const data = JSON.parse(raw);\n      if (data.attributeName && data.attributeValue && data.assignments) {\n        doc = data;\n      }\n    } catch (e) {\n      // Ignore cookie errors\n    }\n    return doc;\n  }\n  saveAssignmentsSync(doc: StickyAssignmentsDocument) {\n    const key = this.getKey(doc.attributeName, doc.attributeValue);\n    if (!this.res) return;\n    const str = JSON.stringify(doc);\n    this.res.cookie(\n      encodeURIComponent(key),\n      encodeURIComponent(str),\n      this.cookieAttributes,\n    );\n  }\n}\n\nexport class BrowserCookieStickyBucketService extends StickyBucketServiceSync {\n  /**\n   * Intended to be used with npm: 'js-cookie'.\n   * Assumes:\n   *  - reading a cookie is automatically decoded via decodeURIComponent() or similar\n   *  - writing a cookie name & value is automatically encoded via encodeURIComponent() or similar\n   *  - all cookie bodies are JSON encoded strings and are manually encoded/decoded\n   */\n  private jsCookie: JsCookiesCompat;\n  private cookieAttributes: CookieAttributes;\n  constructor({\n    prefix = \"gbStickyBuckets__\",\n    jsCookie,\n    cookieAttributes = { expires: 180 }, // 180 days\n  }: {\n    prefix?: string;\n    jsCookie: JsCookiesCompat;\n    cookieAttributes?: CookieAttributes;\n  }) {\n    super();\n    this.prefix = prefix;\n    this.jsCookie = jsCookie;\n    this.cookieAttributes = cookieAttributes;\n  }\n  getAssignmentsSync(attributeName: string, attributeValue: string) {\n    const key = this.getKey(attributeName, attributeValue);\n    let doc: StickyAssignmentsDocument | null = null;\n    if (!this.jsCookie) return doc;\n    try {\n      const raw = this.jsCookie.get(key);\n      const data = JSON.parse(raw || \"{}\");\n      if (data.attributeName && data.attributeValue && data.assignments) {\n        doc = data;\n      }\n    } catch (e) {\n      // Ignore cookie errors\n    }\n    return doc;\n  }\n  async saveAssignmentsSync(doc: StickyAssignmentsDocument) {\n    const key = this.getKey(doc.attributeName, doc.attributeValue);\n    if (!this.jsCookie) return;\n    const str = JSON.stringify(doc);\n    this.jsCookie.set(key, str, this.cookieAttributes);\n  }\n}\n\nexport class RedisStickyBucketService extends StickyBucketService {\n  /** Intended to be used with npm: 'ioredis'. **/\n  private redis: IORedisCompat | undefined;\n  constructor({ redis }: { redis: IORedisCompat }) {\n    super();\n    this.redis = redis;\n  }\n  async getAllAssignments(\n    attributes: Record<string, string>,\n  ): Promise<Record<StickyAttributeKey, StickyAssignmentsDocument>> {\n    const docs: Record<StickyAttributeKey, StickyAssignmentsDocument> = {};\n    const keys = Object.entries(attributes).map(\n      ([attributeName, attributeValue]) =>\n        getStickyBucketAttributeKey(attributeName, attributeValue),\n    );\n    if (!this.redis) return docs;\n    await this.redis.mget(...keys).then((values) => {\n      values.forEach((raw) => {\n        try {\n          const data = JSON.parse(raw || \"{}\");\n          if (\n            data.attributeName &&\n            \"attributeValue\" in data &&\n            data.assignments\n          ) {\n            const key = getStickyBucketAttributeKey(\n              data.attributeName,\n              toString(data.attributeValue),\n            );\n            docs[key] = data;\n          }\n        } catch (e) {\n          // ignore redis doc parse errors\n        }\n      });\n    });\n    return docs;\n  }\n  async getAssignments(_attributeName: string, _attributeValue: string) {\n    // not implemented\n    return null;\n  }\n  async saveAssignments(doc: StickyAssignmentsDocument) {\n    const key = this.getKey(doc.attributeName, doc.attributeValue);\n    if (!this.redis) return;\n    await this.redis.set(key, JSON.stringify(doc));\n  }\n}\n"],"mappings":"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","ignoreList":[]}